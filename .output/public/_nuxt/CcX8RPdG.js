import{d as A,s as Qt,o as Yt,I as Xt,J as en,h as tn,x as F,K as nn,L as ve,r as _,e as Ee,g as B,M as E,y as C,C as P,z as U,B as I,D as O,N as be,_ as $,A as V,O as ze,P as Je,Q as ye,R as ge,S as rn,T as K,U as de}from"./SZ60-geq.js";const an=Symbol.for("nuxt:client-only"),sn=A({name:"ClientOnly",inheritAttrs:!1,props:["fallback","placeholder","placeholderTag","fallbackTag"],setup(e,{slots:n,attrs:r}){const l=Qt(!1);Yt(()=>{l.value=!0});const i=Xt();return i&&(i._nuxtClientOnly=!0),nn(an,!0),()=>{if(l.value){const c=n.default?.();return c&&c.length===1?[en(c[0],r)]:c}const t=n.fallback||n.placeholder;if(t)return tn(t);const a=e.fallback||e.placeholder||"",p=e.fallbackTag||e.placeholderTag||"span";return F(p,r,a)}}});var ue=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function on(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var n=e.default;if(typeof n=="function"){var r=function l(){var i=!1;try{i=this instanceof l}catch{}return i?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};r.prototype=n.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(l){var i=Object.getOwnPropertyDescriptor(e,l);Object.defineProperty(r,l,i.get?i:{enumerable:!0,get:function(){return e[l]}})}),r}var me={exports:{}},ln=me.exports,We;function cn(){return We||(We=1,(function(e,n){(function(r,l){l()})(ln,function(){function r(o,s){return typeof s>"u"?s={autoBom:!1}:typeof s!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),s={autoBom:!s}),s.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(o.type)?new Blob(["\uFEFF",o],{type:o.type}):o}function l(o,s,f){var d=new XMLHttpRequest;d.open("GET",o),d.responseType="blob",d.onload=function(){c(d.response,s,f)},d.onerror=function(){console.error("could not download file")},d.send()}function i(o){var s=new XMLHttpRequest;s.open("HEAD",o,!1);try{s.send()}catch{}return 200<=s.status&&299>=s.status}function t(o){try{o.dispatchEvent(new MouseEvent("click"))}catch{var s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),o.dispatchEvent(s)}}var a=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof ue=="object"&&ue.global===ue?ue:void 0,p=a.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),c=a.saveAs||(typeof window!="object"||window!==a?function(){}:"download"in HTMLAnchorElement.prototype&&!p?function(o,s,f){var d=a.URL||a.webkitURL,u=document.createElement("a");s=s||o.name||"download",u.download=s,u.rel="noopener",typeof o=="string"?(u.href=o,u.origin===location.origin?t(u):i(u.href)?l(o,s,f):t(u,u.target="_blank")):(u.href=d.createObjectURL(o),setTimeout(function(){d.revokeObjectURL(u.href)},4e4),setTimeout(function(){t(u)},0))}:"msSaveOrOpenBlob"in navigator?function(o,s,f){if(s=s||o.name||"download",typeof o!="string")navigator.msSaveOrOpenBlob(r(o,f),s);else if(i(o))l(o,s,f);else{var d=document.createElement("a");d.href=o,d.target="_blank",setTimeout(function(){t(d)})}}:function(o,s,f,d){if(d=d||open("","_blank"),d&&(d.document.title=d.document.body.innerText="downloading..."),typeof o=="string")return l(o,s,f);var u=o.type==="application/octet-stream",v=/constructor/i.test(a.HTMLElement)||a.safari,g=/CriOS\/[\d]+/.test(navigator.userAgent);if((g||u&&v||p)&&typeof FileReader<"u"){var y=new FileReader;y.onloadend=function(){var S=y.result;S=g?S:S.replace(/^data:[^;]*;/,"data:attachment/file;"),d?d.location.href=S:location=S,d=null},y.readAsDataURL(o)}else{var b=a.URL||a.webkitURL,h=b.createObjectURL(o);d?d.location=h:location.href=h,d=null,setTimeout(function(){b.revokeObjectURL(h)},4e4)}});a.saveAs=c.saveAs=c,e.exports=c})})(me)),me.exports}var R=cn();const mt=[1,2,4,8,16,32,64],D={bars:1,division:16};function ht(e,n){return 60/e*(4/n)}function L(e){const n=mt.includes(e?.division??D.division)?e?.division:D.division;return{bars:e?.bars===1||e?.bars===2||e?.bars===4||e?.bars===8?e.bars:D.bars,division:n}}const $e=ve("transport",{state:()=>({bpm:120,isPlaying:!1,loop:!0,gridSpec:{...D},currentStep:0}),actions:{setBpm(e){this.bpm=e},setPlaying(e){this.isPlaying=e},setGridSpec(e){this.gridSpec=L(e)},setLoop(e){this.loop=e},setCurrentStep(e){this.currentStep=e}}}),Z=[.7,1,1.25],ne=Z[0],vt=Z[Z.length-1],dn=.001,bt=(e,n)=>Math.abs(e-n)<dn;function te(e){const n=typeof e=="number"?e:ne,r=Math.max(Z[0],Math.min(vt,n));return Z.find(i=>bt(r,i))??r}function yt(e){if(typeof e!="number")return ne;const n=Z.findIndex(i=>bt(e,i));if(n===-1)return ne;const r=n+1;if(r>=Z.length)return null;const l=Z[r];return typeof l!="number"?null:l}const un=()=>({...D}),pe=(e,n)=>({id:e,name:n,gridSpec:un(),steps:{}}),pn=(e,n,r=[])=>({id:e,name:n,patternIds:r}),fn=50,gt=ve("patterns",{state:()=>({patterns:[pe("pattern-1","Pattern 1")],scenes:[],selectedPatternId:"pattern-1",activeSceneId:null,scenePosition:0,history:[],historyIndex:-1,isRestoring:!1}),getters:{currentPattern(e){return e.patterns.find(n=>n.id===e.selectedPatternId)??pe("pattern-1","Pattern 1")},currentScene(e){return e.scenes.find(n=>n.id===e.activeSceneId)??null}},actions:{snapshotState(){return{patterns:JSON.parse(JSON.stringify(this.patterns)),scenes:JSON.parse(JSON.stringify(this.scenes)),selectedPatternId:this.selectedPatternId,activeSceneId:this.activeSceneId}},recordHistory(){if(this.isRestoring)return;const e=this.snapshotState();this.history=this.history.slice(0,this.historyIndex+1),this.history.push(e),this.history.length>fn&&(this.history.shift(),this.historyIndex-=1),this.historyIndex=this.history.length-1},restoreSnapshot(e){this.isRestoring=!0,this.patterns=e.patterns.map(n=>({...n,gridSpec:L(n.gridSpec)})),this.setScenes(e.scenes),this.selectedPatternId=e.selectedPatternId,this.patterns.find(n=>n.id===this.selectedPatternId)||(this.selectedPatternId=this.patterns[0]?.id??"pattern-1"),this.activeSceneId=e.activeSceneId,this.scenePosition=0,this.isRestoring=!1},undo(){if(this.historyIndex<=0)return;this.historyIndex-=1;const e=this.history[this.historyIndex];e&&this.restoreSnapshot(e)},redo(){if(this.historyIndex>=this.history.length-1)return;this.historyIndex+=1;const e=this.history[this.historyIndex];e&&this.restoreSnapshot(e)},selectPattern(e){this.selectedPatternId=e},addPattern(e){this.recordHistory();const n=this.patterns.length+1,r=`pattern-${Date.now()}-${n}`,l=pe(r,e??`Pattern ${n}`);this.patterns.push(l),this.selectedPatternId=l.id},renamePattern(e,n){this.recordHistory();const r=this.patterns.find(l=>l.id===e);r&&(r.name=n)},setScenes(e){const n=this.patterns.map(r=>r.id);this.scenes=e.map(r=>({...r,patternIds:r.patternIds.filter(l=>n.includes(l))})),this.activeSceneId&&!this.scenes.find(r=>r.id===this.activeSceneId)&&(this.activeSceneId=null,this.scenePosition=0)},setPatterns(e){this.patterns=e.length?e:[pe("pattern-1","Pattern 1")],this.patterns.find(r=>r.id===this.selectedPatternId)||(this.selectedPatternId=this.patterns[0]?.id??"pattern-1");const n=this.patterns.map(r=>r.id);this.scenes=this.scenes.map(r=>({...r,patternIds:r.patternIds.filter(l=>n.includes(l))})),this.activeSceneId&&!this.scenes.find(r=>r.id===this.activeSceneId)&&(this.activeSceneId=null,this.scenePosition=0)},toggleStep(e,n,r){this.recordHistory();const i=this.currentPattern.steps,t=i[e]??{},p={...t[n]??{}},c=yt(p[r]?.velocity?.value);c===null?delete p[r]:p[r]={velocity:{value:te(c)}},i[e]={...t,[n]:p}},setStepVelocity(e,n,r,l){this.recordHistory();const t=this.currentPattern.steps,a=t[e]??{},c={...a[n]??{}};c[r]={velocity:{value:te(l||ne)}},t[e]={...a,[n]:c}},updateGridSpec(e){this.recordHistory();const n=this.currentPattern;n.gridSpec=L(e)},addScene(e,n=[]){this.recordHistory();const r=`scene-${Date.now()}-${this.scenes.length+1}`;this.scenes.push(pn(r,e,n)),this.activeSceneId=r,this.scenePosition=0},updateScene(e,n){this.recordHistory();const r=this.scenes.find(l=>l.id===e);if(r&&(n.name&&(r.name=n.name),n.patternIds)){const l=this.patterns.map(i=>i.id);r.patternIds=n.patternIds.filter(i=>l.includes(i))}},selectScene(e){this.activeSceneId=e,this.scenePosition=0},prepareScenePlayback(){this.scenePosition=0;const e=this.currentScene;if(e&&e.patternIds.length>0){const n=e.patternIds[0];n&&(this.selectedPatternId=n),this.scenePosition=e.patternIds.length>1?1:0}},advanceScenePlayback(){const e=this.currentScene;if(!e||e.patternIds.length===0)return this.currentPattern;const n=e.patternIds[this.scenePosition%e.patternIds.length];return this.scenePosition=(this.scenePosition+1)%e.patternIds.length,n&&(this.selectedPatternId=n),this.currentPattern}}}),mn=ve("soundbanks",{state:()=>({banks:[],selectedBankId:""}),getters:{currentBank(e){return e.banks.find(n=>n.id===e.selectedBankId)}},actions:{setBanks(e){if(this.banks=e,!this.selectedBankId&&e.length>0){const n=e[0];n&&(this.selectedBankId=n.id)}},selectBank(e){this.selectedBankId=e},upsertBank(e){const n=this.banks.findIndex(r=>r.id===e.id);n>=0?this.banks.splice(n,1,e):this.banks.push(e)}}}),hn=ve("session",{state:()=>({midiInput:void 0,midiOutput:void 0,audioReady:!1,capabilities:{supportsWebMIDI:!1,supportsAudioInput:!1}}),actions:{setMidiInput(e){this.midiInput=e},setMidiOutput(e){this.midiOutput=e},setAudioReady(e){this.audioReady=e},setCapabilities(e){this.capabilities=e}}});function vn(e,n,r,l){const i=r*l,t=Math.max(0,Math.min(i-1,Math.round(e/n)));return{barIndex:Math.floor(t/l),stepInBar:t%l}}function St(e){const n=_([]),r=_(null),l=()=>{const o=e.getTime()+e.scheduleAheadSec,s=n.value.filter(f=>f.when<=o);n.value=n.value.filter(f=>f.when>o),s.forEach(f=>f.callback())},i=()=>{r.value===null&&(r.value=window.setInterval(l,e.lookahead))},t=()=>{r.value!==null&&(clearInterval(r.value),r.value=null)},a=c=>{n.value.push(c)},p=()=>{n.value=[]};return Ee(t),{start:i,stop:t,clear:p,tick:l,schedule:a}}function kt(e){let n=e>>>0;return()=>{n+=1831565813;let r=n;return r=Math.imul(r^r>>>15,r|1),r^=r+Math.imul(r^r>>>7,r|61),((r^r>>>14)>>>0)/4294967296}}const It=e=>({fxInput:e.createGain(),driveNode:e.createWaveShaper(),filterNode:(()=>{const n=e.createBiquadFilter();return n.type="lowpass",n})(),dryGain:e.createGain(),wetGain:e.createGain(),reverbNode:e.createConvolver(),connected:!1}),wt=(e,n)=>{e.connected||(e.fxInput.connect(e.driveNode),e.driveNode.connect(e.filterNode),e.filterNode.connect(e.dryGain),e.filterNode.connect(e.reverbNode),e.reverbNode.connect(e.wetGain),e.dryGain.connect(n),e.wetGain.connect(n),e.connected=!0)},Pt=(e,n,r,l)=>{const i=e.currentTime,t=r.filter.enabled?r.filter.frequency:e.sampleRate/2;n.filterNode.frequency.setValueAtTime(t,i),n.filterNode.Q.setValueAtTime(r.filter.q,i);const a=r.drive.enabled?r.drive.amount:0;n.driveNode.curve=bn(a);const p=r.reverb.enabled?r.reverb.mix:0;n.dryGain.gain.setValueAtTime(Math.max(0,1-p),i),n.wetGain.gain.setValueAtTime(Math.max(0,Math.min(1,p)),i),r.reverb.enabled?n.reverbNode.buffer||(n.reverbNode.buffer=yn(e,l)):n.reverbNode.buffer&&(n.reverbNode.buffer=null)},bn=e=>{const n=Math.max(0,e)*50+1,r=1024,l=new Float32Array(r);for(let i=0;i<r;i+=1){const t=i*2/r-1;l[i]=(1+n)*t/(1+n*Math.abs(t))}return l},yn=(e,n,r=1.2,l=2.5)=>{const i=Math.max(1,Math.floor(e.sampleRate*r)),t=e.createBuffer(2,i,e.sampleRate);for(let a=0;a<t.numberOfChannels;a+=1){const p=t.getChannelData(a);for(let c=0;c<i;c+=1)p[c]=(n()*2-1)*Math.pow(1-c/i,l)}return t},Ue=e=>({filter:{...e.filter},drive:{...e.drive},reverb:{...e.reverb}}),gn=()=>{const e=_(null),n=_(null),r=_(new Map),l=_({filter:{enabled:!0,frequency:12e3,q:.7},drive:{enabled:!1,amount:.25},reverb:{enabled:!1,mix:.15}}),i=_(Ue(l.value)),t=_(null);let a=kt(0);const p=()=>(i.value=Ue(l.value),i.value),c=(h,S)=>{n.value&&(t.value||(t.value=It(h),wt(t.value,n.value)),Pt(h,t.value,S,a))},o=()=>{if(!e.value){const h=new AudioContext,S=h.createGain();S.gain.value=.8,S.connect(h.destination),e.value=h,n.value=S}return c(e.value,i.value),e.value},s=async()=>{const h=o();return h.state==="suspended"&&await h.resume(),h},f=()=>Ue(i.value),d=h=>{a=h,t.value?.reverbNode&&(t.value.reverbNode.buffer=null),e.value&&c(e.value,i.value)},u=async h=>{const S=o();if(h.buffer)return h.buffer;if(h.blob){const m=await h.blob.arrayBuffer();return S.decodeAudioData(m.slice(0))}if(h.url){const w=await(await fetch(h.url)).arrayBuffer();return S.decodeAudioData(w)}return null},v=async(h,S)=>{const m=S.buffer??await u(S);m&&r.value.set(h,m)},g=async h=>{const S=Object.entries(h.pads);await Promise.all(S.map(async([m,w])=>{w&&await v(m,w)}))},y=h=>{l.value={filter:{...l.value.filter,...h.filter??{}},drive:{...l.value.drive,...h.drive??{}},reverb:{...l.value.reverb,...h.reverb??{}}};const S=p(),m=o();c(m,S)},b=async({padId:h,when:S,velocity:m=1})=>{const w=o(),k=r.value.get(h)??null;if(!k)return;const x=w.createBufferSource();x.buffer=k;const T=w.createGain();T.gain.value=m,x.connect(T),t.value?T.connect(t.value.fxInput):T.connect(n.value??w.destination),x.start(S)};return Ee(()=>{e.value?.close(),r.value.clear()}),{audioContext:e,masterGain:n,sampleCache:r,fxSettings:l,ensureContext:o,resumeContext:s,decodeSample:u,applySoundbank:g,setFx:y,setSampleForPad:v,trigger:b,getFxSnapshot:f,setFxRandomSource:d}};let Be=null;function xt(){return Be||(Be=gn()),Be}function Tt(e,n=!1){return{ctx:e,isOffline:n,now:()=>e.currentTime}}const Sn=e=>e.bars*e.division;function Ve(e,n){const r=e.getPattern(),l=Sn(r.gridSpec),i=e.currentStep.value%l,t=Math.floor(i/r.gridSpec.division),a=i%r.gridSpec.division,p=Math.max(n,e.clock.now());e.pendingSteps.value.push({when:p,stepAddress:{barIndex:t,stepInBar:a}}),e.scheduler.schedule({when:p,callback:()=>{const o=r.steps[t]?.[a];o&&Object.entries(o).forEach(([d,u])=>{e.audio.trigger({padId:d,when:p,velocity:u?.velocity?.value??1})}),e.currentStep.value=(e.currentStep.value+1)%l,e.transport.setCurrentStep(e.currentStep.value);const s=e.currentStep.value===0;let f=r;if(s&&e.onPatternBoundary){const d=e.onPatternBoundary();d?(f=d,e.transport.setGridSpec(f.gridSpec)):f=e.getPattern()}if(e.transport.loop){const d=ht(e.transport.bpm,f.gridSpec.division);Ve(e,p+d)}}})}function kn(e){const n=$e(),r=xt();let l=null;const i=St({lookahead:e.lookahead??25,scheduleAheadSec:e.scheduleAheadSec??.1,getTime:()=>l?.now()??0}),t=_(0),a=_(!1),p=_([]);let c=0;const o=e.onPatternBoundary??(()=>{}),s=S=>({clock:S,scheduler:i,audio:r,transport:n,getPattern:e.getPattern,currentStep:t,pendingSteps:p,onPatternBoundary:o}),f=async()=>{if(n.isPlaying)return;const S=await r.resumeContext();l=Tt(S);const m=e.getPattern(),w=L(m.gridSpec);m.gridSpec=w,n.setGridSpec(w),c=l.now(),t.value=0,p.value=[],n.setCurrentStep(0),n.setPlaying(!0),i.clear();const k=s(l);Ve(k,c),i.start(),i.tick()},d=()=>{n.setPlaying(!1),i.stop(),i.clear(),p.value=[],t.value=0,n.setCurrentStep(0),c=0,l=null},u=(S,m,w)=>{const k=e.getPattern(),x=k.steps[S]??{},M={...x[m]??{}},N=yt(M[w]?.velocity?.value);N===null?delete M[w]:M[w]={velocity:{value:te(N)}},k.steps[S]={...x,[m]:M}},v=(S,m,w,k)=>{const x=e.getPattern(),T=x.steps[S]??{},N={...T[m]??{},[w]:{velocity:{value:te(k||ne)}}};x.steps[S]={...T,[m]:N}},g=async(S,m=1,w=!0)=>{const k=e.getPattern(),x=await r.resumeContext(),T=k.gridSpec,M=ht(n.bpm,T.division),N=te(m),j=n.isPlaying?c:x.currentTime;n.isPlaying||(c=j);const J=x.currentTime-j,G=w?vn(J,M,T.bars,T.division):{barIndex:Math.floor(t.value/T.division),stepInBar:t.value%T.division};v(G.barIndex,G.stepInBar,S,N),r.trigger({padId:S,when:x.currentTime,velocity:N})},y=async(S,m)=>{await r.setSampleForPad(S,m)},b=async S=>{await r.applySoundbank(S)},h=()=>l?.now()??r.ensureContext().currentTime;return{currentStep:t,isRecording:a,pendingSteps:p,start:f,stop:d,toggleStep:u,setStepVelocity:v,recordHit:g,fxSettings:r.fxSettings,setFx:r.setFx,setSampleForPad:y,applySoundbank:b,getAudioTime:h}}const Ke=24,In="audioContext";function wn(e="internal",n){const r=_({bpm:120,phase:0,isPlaying:!1,mode:e,role:"master",linkAvailable:!1,clockAuthority:In,bpmSource:"transport"}),l=n?.getAudioTime?St({lookahead:25,scheduleAheadSec:.05,getTime:n.getAudioTime}):null,i=_(r.value.bpm);let t=null,a=null;const p=()=>60/(r.value.bpm*Ke),c=()=>{r.value.phase=0},o=()=>{l?.stop(),l?.clear(),t=null,n?.midi?.sendStop()},s=()=>{r.value.phase=(r.value.phase+1)%Ke},f=()=>{!l||t===null||l.schedule({when:t,callback:()=>{n?.midi?.sendClockTick(),s(),t!==null&&(t=t+p(),f())}})},d=()=>{if(o(),r.value.mode!=="midiClock"||r.value.role!=="master"||!n?.midi?.selectedOutputId.value||!n?.getAudioTime||!l)return;t=n.getAudioTime()+p(),n.midi.sendStart(),f(),l.start(),l.tick()},u=m=>{r.value.mode=m,r.value.bpm=i.value,o(),r.value.isPlaying&&r.value.mode==="midiClock"&&r.value.role==="master"&&d()},v=m=>{r.value.role=m,r.value.bpm=i.value,o(),r.value.isPlaying&&r.value.mode==="midiClock"&&r.value.role==="master"&&d()},g=m=>{r.value.isPlaying=m,m?d():o()},y=m=>{r.value.bpm=Math.max(20,Math.min(300,m)),i.value=r.value.bpm,r.value.isPlaying&&r.value.mode==="midiClock"&&r.value.role==="master"&&d()},b=m=>{r.value.mode!=="midiClock"||r.value.role!=="slave"||(m.type==="start"?(r.value.isPlaying=!0,c(),n?.onExternalStart?.()):m.type==="stop"?(r.value.isPlaying=!1,c(),n?.onExternalStop?.()):m.type==="clock"&&s())},h=m=>{y(m),g(!0)},S=()=>{g(!1)};return n?.midi&&(a=n.midi.listen(b)),Ee(()=>{o(),a?.()}),{state:r,setMode:u,setRole:v,setPlaying:g,setBpm:y,startTransport:h,stopTransport:S}}const Pn=["pad1","pad2","pad3","pad4","pad5","pad6","pad7","pad8","pad9","pad10","pad11","pad12","pad13","pad14","pad15","pad16"];function Ne(){const e={},n={};return Pn.forEach((r,l)=>{const i=36+l;e[i]=r,n[r]=i}),{noteMap:e,noteMapInverse:n}}function xn(){const e=_(null),n=_([]),r=_([]),l=_(Ne()),i=_(null),t=_(null),a=_(new Set),p=()=>typeof navigator<"u"&&!!navigator.requestMIDIAccess,c=()=>{e.value&&(n.value=Array.from(e.value.inputs.values()).map(k=>({id:k.id,name:k.name??"MIDI In",type:"input"})),r.value=Array.from(e.value.outputs.values()).map(k=>({id:k.id,name:k.name??"MIDI Out",type:"output"})))},o=async()=>{p()&&(e.value=await navigator.requestMIDIAccess({sysex:!1}),c(),e.value&&(e.value.onstatechange=()=>{c(),d()}))},s=k=>{if(!k.data||k.data.length<1)return;const x=k.data[0],T=k.data[1],M=k.data[2];if(x===void 0)return;const N=x&240,j=typeof T=="number"&&typeof M=="number",J=N===144&&j&&M>0?{type:"noteon",note:T,velocity:M/127}:N===128&&j?{type:"noteoff",note:T,velocity:M/127}:N===144&&j&&M===0?{type:"noteoff",note:T,velocity:M/127}:x===248?{type:"clock"}:x===250?{type:"start"}:x===252?{type:"stop"}:null;J&&a.value.forEach(G=>G(J))},f=()=>{e.value?.inputs.forEach(k=>{k.onmidimessage=null})},d=()=>{if(f(),!i.value)return;const k=e.value?.inputs.get(i.value);k&&(k.onmidimessage=s)},u=k=>(a.value.add(k),d(),()=>a.value.delete(k)),v=(k,x)=>{const T=e.value?.outputs.get(k);if(T)switch(x.type){case"noteon":T.send([144,x.note??0,Math.floor((x.velocity??1)*127)]);break;case"noteoff":T.send([128,x.note??0,0]);break;case"start":T.send([250]);break;case"stop":T.send([252]);break;case"clock":T.send([248]);break}};return{access:e,inputs:n,outputs:r,mapping:l,selectedInputId:i,selectedOutputId:t,supportsMidi:p,requestAccess:o,refreshDevices:c,listen:u,send:v,sendClockTick:()=>{t.value&&v(t.value,{type:"clock"})},sendStart:()=>{t.value&&v(t.value,{type:"start"})},sendStop:()=>{t.value&&v(t.value,{type:"stop"})},mapNoteToPad:k=>l.value.noteMap[k],setPadForNote:(k,x)=>{x?l.value.noteMap[k]=x:delete l.value.noteMap[k]},setSelectedInput:k=>{i.value=k,d()},setSelectedOutput:k=>{t.value=k}}}const Ce="drum-machine/patterns",Tn="v2",Ze=(e,n)=>({id:e?.id??`pattern-${n+1}`,name:e?.name??`Pattern ${n+1}`,gridSpec:L(e?.gridSpec??D),steps:e?.steps??{}});function Un(){const e=_(null);return{save:i=>{if(typeof window>"u")return;const t=i.patterns.map((p,c)=>Ze(p,c)),a={version:Tn,savedAt:Date.now(),patterns:t,scenes:i.scenes??[],selectedPatternId:i.selectedPatternId,activeSceneId:i.activeSceneId??null};localStorage.setItem(Ce,JSON.stringify(a)),e.value=a.savedAt},load:()=>{if(typeof window>"u")return{patterns:[],scenes:[],selectedPatternId:"pattern-1",activeSceneId:null};const i=localStorage.getItem(Ce);if(!i)return{patterns:[],scenes:[],selectedPatternId:"pattern-1",activeSceneId:null};try{const t=JSON.parse(i),a=t.version,p=Array.isArray(t.patterns)?t.patterns.map((o,s)=>Ze(o,s)):[],c={patterns:p,scenes:[],selectedPatternId:p[0]?.id??"pattern-1",activeSceneId:null};if(a==="v2"){const o=t;return typeof o.savedAt=="number"&&(e.value=o.savedAt),{patterns:p,scenes:Array.isArray(o.scenes)?o.scenes:[],selectedPatternId:o.selectedPatternId??c.selectedPatternId,activeSceneId:o.activeSceneId??null}}return typeof t.savedAt=="number"&&(e.value=t.savedAt??null),c}catch(t){return console.error("Failed to parse patterns from LocalStorage",t),{patterns:[],scenes:[],selectedPatternId:"pattern-1",activeSceneId:null}}},clear:()=>{typeof window>"u"||localStorage.removeItem(Ce)},lastSavedAt:e}}const Bn="drum-machine-db",Cn=2,_n=e=>{if(!e)return;const n={id:e.id,name:e.name};return e.url!==void 0&&(n.url=e.url),e.format!==void 0&&(n.format=e.format),n},On=e=>{const n={};return Object.entries(e.pads).forEach(([r,l])=>{const i=_n(l);i&&(n[r]=i)}),{id:e.id,name:e.name,createdAt:e.createdAt,updatedAt:e.updatedAt,pads:n}};function Mn(){const e=_(null),n=()=>new Promise((o,s)=>{const f=indexedDB.open(Bn,Cn);f.onupgradeneeded=()=>{const d=f.result;d.objectStoreNames.contains("soundbanks")||d.createObjectStore("soundbanks",{keyPath:"id"}),d.objectStoreNames.contains("samples")||d.createObjectStore("samples",{keyPath:"id"}),d.objectStoreNames.contains("patterns")||d.createObjectStore("patterns",{keyPath:"id"}).createIndex("bankId","bankId",{unique:!1})},f.onerror=()=>s(f.error),f.onsuccess=()=>{e.value=f.result,o(f.result)}}),r=async()=>e.value?e.value:n();return{saveBank:async o=>{const s=await r();return new Promise((f,d)=>{const u=s.transaction(["soundbanks"],"readwrite");u.objectStore("soundbanks").put(On(o)),u.oncomplete=()=>f(),u.onerror=()=>d(u.error)})},saveSample:async o=>{const s=await r();return new Promise((f,d)=>{const u=s.transaction(["samples"],"readwrite"),v={id:o.id,name:o.name,blob:o.blob};o.format&&(v.format=o.format),u.objectStore("samples").put(v),u.oncomplete=()=>f(),u.onerror=()=>d(u.error)})},loadBanks:async()=>{const o=await r();return new Promise((s,f)=>{const u=o.transaction(["soundbanks"],"readonly").objectStore("soundbanks").getAll();u.onsuccess=()=>s(u.result??[]),u.onerror=()=>f(u.error)})},loadSample:async o=>{const s=await r();return new Promise((f,d)=>{const v=s.transaction(["samples"],"readonly").objectStore("samples").get(o);v.onsuccess=()=>{const g=v.result;if(!g){f(null);return}const y={id:g.id,name:g.name,blob:g.blob},b=g.format;b&&(y.format=b),f(y)},v.onerror=()=>d(v.error)})},savePatterns:async(o,s)=>{const f=await r();return new Promise((d,u)=>{const v=f.transaction(["patterns"],"readwrite");s.forEach(g=>{const y={id:`${o}:${g.id}`,bankId:o,pattern:g};v.objectStore("patterns").put(y)}),v.oncomplete=()=>d(),v.onerror=()=>u(v.error)})},loadPatterns:async o=>{const s=await r();return new Promise((f,d)=>{const g=s.transaction(["patterns"],"readonly").objectStore("patterns").index("bankId").getAll(o);g.onsuccess=()=>{const y=g.result??[];f(y.map(b=>b.pattern))},g.onerror=()=>d(g.error)})}}}var Y={},fe={},_e,Qe;function Fn(){if(Qe)return _e;Qe=1;function e(i){var t=new l(i),a=t.readChunk();if(a.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+a.id+"'";for(var p=n(a.data),c=[],o=0;!t.eof()&&o<p.numTracks;o++){var s=t.readChunk();if(s.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+s.id+"'";var f=r(s.data);c.push(f)}return{header:p,tracks:c}}function n(i){var t=new l(i),a=t.readUInt16(),p=t.readUInt16(),c={format:a,numTracks:p},o=t.readUInt16();return o&32768?(c.framesPerSecond=256-(o>>8),c.ticksPerFrame=o&255):c.ticksPerBeat=o,c}function r(i){for(var t=new l(i),a=[];!t.eof();){var p=o();a.push(p)}return a;var c;function o(){var s={};s.deltaTime=t.readVarInt();var f=t.readUInt8();if((f&240)===240)if(f===255){s.meta=!0;var d=t.readUInt8(),u=t.readVarInt();switch(d){case 0:if(s.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return s.number=t.readUInt16(),s;case 1:return s.type="text",s.text=t.readString(u),s;case 2:return s.type="copyrightNotice",s.text=t.readString(u),s;case 3:return s.type="trackName",s.text=t.readString(u),s;case 4:return s.type="instrumentName",s.text=t.readString(u),s;case 5:return s.type="lyrics",s.text=t.readString(u),s;case 6:return s.type="marker",s.text=t.readString(u),s;case 7:return s.type="cuePoint",s.text=t.readString(u),s;case 32:if(s.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return s.channel=t.readUInt8(),s;case 33:if(s.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return s.port=t.readUInt8(),s;case 47:if(s.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return s;case 81:if(s.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return s.microsecondsPerBeat=t.readUInt24(),s;case 84:if(s.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var v=t.readUInt8(),g={0:24,32:25,64:29,96:30};return s.frameRate=g[v&96],s.hour=v&31,s.min=t.readUInt8(),s.sec=t.readUInt8(),s.frame=t.readUInt8(),s.subFrame=t.readUInt8(),s;case 88:if(s.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return s.numerator=t.readUInt8(),s.denominator=1<<t.readUInt8(),u===4?(s.metronome=t.readUInt8(),s.thirtyseconds=t.readUInt8()):(s.metronome=36,s.thirtyseconds=8),s;case 89:if(s.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return s.key=t.readInt8(),s.scale=t.readUInt8(),s;case 127:return s.type="sequencerSpecific",s.data=t.readBytes(u),s;default:return s.type="unknownMeta",s.data=t.readBytes(u),s.metatypeByte=d,s}}else if(f==240){s.type="sysEx";var u=t.readVarInt();return s.data=t.readBytes(u),s}else if(f==247){s.type="endSysEx";var u=t.readVarInt();return s.data=t.readBytes(u),s}else throw"Unrecognised MIDI event type byte: "+f;else{var y;if((f&128)===0){if(c===null)throw"Running status byte encountered before status byte";y=f,f=c,s.running=!0}else y=t.readUInt8(),c=f;var b=f>>4;switch(s.channel=f&15,b){case 8:return s.type="noteOff",s.noteNumber=y,s.velocity=t.readUInt8(),s;case 9:var h=t.readUInt8();return s.type=h===0?"noteOff":"noteOn",s.noteNumber=y,s.velocity=h,h===0&&(s.byte9=!0),s;case 10:return s.type="noteAftertouch",s.noteNumber=y,s.amount=t.readUInt8(),s;case 11:return s.type="controller",s.controllerType=y,s.value=t.readUInt8(),s;case 12:return s.type="programChange",s.programNumber=y,s;case 13:return s.type="channelAftertouch",s.amount=y,s;case 14:return s.type="pitchBend",s.value=y+(t.readUInt8()<<7)-8192,s;default:throw"Unrecognised MIDI event type: "+b}}}}function l(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}return l.prototype.eof=function(){return this.pos>=this.bufferLen},l.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i},l.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i},l.prototype.readUInt16=function(){var i=this.readUInt8(),t=this.readUInt8();return(i<<8)+t},l.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i},l.prototype.readUInt24=function(){var i=this.readUInt8(),t=this.readUInt8(),a=this.readUInt8();return(i<<16)+(t<<8)+a},l.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i},l.prototype.readUInt32=function(){var i=this.readUInt8(),t=this.readUInt8(),a=this.readUInt8(),p=this.readUInt8();return(i<<24)+(t<<16)+(a<<8)+p},l.prototype.readBytes=function(i){var t=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,t},l.prototype.readString=function(i){var t=this.readBytes(i);return String.fromCharCode.apply(null,t)},l.prototype.readVarInt=function(){for(var i=0;!this.eof();){var t=this.readUInt8();if(t&128)i+=t&127,i<<=7;else return i+t}return i},l.prototype.readChunk=function(){var i=this.readString(4),t=this.readUInt32(),a=this.readBytes(t);return{id:i,length:t,data:a}},_e=e,_e}var Oe,Ye;function Nn(){if(Ye)return Oe;Ye=1;function e(t,a){if(typeof t!="object")throw"Invalid MIDI data";a=a||{};var p=t.header||{},c=t.tracks||[],o,s=c.length,f=new i;for(n(f,p,s),o=0;o<s;o++)r(f,c[o],a);return f.buffer}function n(t,a,p){var c=a.format==null?1:a.format,o=128;a.timeDivision?o=a.timeDivision:a.ticksPerFrame&&a.framesPerSecond?o=-(a.framesPerSecond&255)<<8|a.ticksPerFrame&255:a.ticksPerBeat&&(o=a.ticksPerBeat&32767);var s=new i;s.writeUInt16(c),s.writeUInt16(p),s.writeUInt16(o),t.writeChunk("MThd",s.buffer)}function r(t,a,p){var c=new i,o,s=a.length,f=null;for(o=0;o<s;o++)(p.running===!1||!p.running&&!a[o].running)&&(f=null),f=l(c,a[o],f,p.useByte9ForNoteOff);t.writeChunk("MTrk",c.buffer)}function l(t,a,p,c){var o=a.type,s=a.deltaTime,f=a.text||"",d=a.data||[],u=null;switch(t.writeVarInt(s),o){case"sequenceNumber":t.writeUInt8(255),t.writeUInt8(0),t.writeVarInt(2),t.writeUInt16(a.number);break;case"text":t.writeUInt8(255),t.writeUInt8(1),t.writeVarInt(f.length),t.writeString(f);break;case"copyrightNotice":t.writeUInt8(255),t.writeUInt8(2),t.writeVarInt(f.length),t.writeString(f);break;case"trackName":t.writeUInt8(255),t.writeUInt8(3),t.writeVarInt(f.length),t.writeString(f);break;case"instrumentName":t.writeUInt8(255),t.writeUInt8(4),t.writeVarInt(f.length),t.writeString(f);break;case"lyrics":t.writeUInt8(255),t.writeUInt8(5),t.writeVarInt(f.length),t.writeString(f);break;case"marker":t.writeUInt8(255),t.writeUInt8(6),t.writeVarInt(f.length),t.writeString(f);break;case"cuePoint":t.writeUInt8(255),t.writeUInt8(7),t.writeVarInt(f.length),t.writeString(f);break;case"channelPrefix":t.writeUInt8(255),t.writeUInt8(32),t.writeVarInt(1),t.writeUInt8(a.channel);break;case"portPrefix":t.writeUInt8(255),t.writeUInt8(33),t.writeVarInt(1),t.writeUInt8(a.port);break;case"endOfTrack":t.writeUInt8(255),t.writeUInt8(47),t.writeVarInt(0);break;case"setTempo":t.writeUInt8(255),t.writeUInt8(81),t.writeVarInt(3),t.writeUInt24(a.microsecondsPerBeat);break;case"smpteOffset":t.writeUInt8(255),t.writeUInt8(84),t.writeVarInt(5);var v={24:0,25:32,29:64,30:96},g=a.hour&31|v[a.frameRate];t.writeUInt8(g),t.writeUInt8(a.min),t.writeUInt8(a.sec),t.writeUInt8(a.frame),t.writeUInt8(a.subFrame);break;case"timeSignature":t.writeUInt8(255),t.writeUInt8(88),t.writeVarInt(4),t.writeUInt8(a.numerator);var y=Math.floor(Math.log(a.denominator)/Math.LN2)&255;t.writeUInt8(y),t.writeUInt8(a.metronome),t.writeUInt8(a.thirtyseconds||8);break;case"keySignature":t.writeUInt8(255),t.writeUInt8(89),t.writeVarInt(2),t.writeInt8(a.key),t.writeUInt8(a.scale);break;case"sequencerSpecific":t.writeUInt8(255),t.writeUInt8(127),t.writeVarInt(d.length),t.writeBytes(d);break;case"unknownMeta":a.metatypeByte!=null&&(t.writeUInt8(255),t.writeUInt8(a.metatypeByte),t.writeVarInt(d.length),t.writeBytes(d));break;case"sysEx":t.writeUInt8(240),t.writeVarInt(d.length),t.writeBytes(d);break;case"endSysEx":t.writeUInt8(247),t.writeVarInt(d.length),t.writeBytes(d);break;case"noteOff":var b=c!==!1&&a.byte9||c&&a.velocity==0?144:128;u=b|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.noteNumber),t.writeUInt8(a.velocity);break;case"noteOn":u=144|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.noteNumber),t.writeUInt8(a.velocity);break;case"noteAftertouch":u=160|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.noteNumber),t.writeUInt8(a.amount);break;case"controller":u=176|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.controllerType),t.writeUInt8(a.value);break;case"programChange":u=192|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.programNumber);break;case"channelAftertouch":u=208|a.channel,u!==p&&t.writeUInt8(u),t.writeUInt8(a.amount);break;case"pitchBend":u=224|a.channel,u!==p&&t.writeUInt8(u);var h=8192+a.value,S=h&127,m=h>>7&127;t.writeUInt8(S),t.writeUInt8(m);break;default:throw"Unrecognized event type: "+o}return u}function i(){this.buffer=[]}return i.prototype.writeUInt8=function(t){this.buffer.push(t&255)},i.prototype.writeInt8=i.prototype.writeUInt8,i.prototype.writeUInt16=function(t){var a=t>>8&255,p=t&255;this.writeUInt8(a),this.writeUInt8(p)},i.prototype.writeInt16=i.prototype.writeUInt16,i.prototype.writeUInt24=function(t){var a=t>>16&255,p=t>>8&255,c=t&255;this.writeUInt8(a),this.writeUInt8(p),this.writeUInt8(c)},i.prototype.writeInt24=i.prototype.writeUInt24,i.prototype.writeUInt32=function(t){var a=t>>24&255,p=t>>16&255,c=t>>8&255,o=t&255;this.writeUInt8(a),this.writeUInt8(p),this.writeUInt8(c),this.writeUInt8(o)},i.prototype.writeInt32=i.prototype.writeUInt32,i.prototype.writeBytes=function(t){this.buffer=this.buffer.concat(Array.prototype.slice.call(t,0))},i.prototype.writeString=function(t){var a,p=t.length,c=[];for(a=0;a<p;a++)c.push(t.codePointAt(a));this.writeBytes(c)},i.prototype.writeVarInt=function(t){if(t<0)throw"Cannot write negative variable-length integer";if(t<=127)this.writeUInt8(t);else{var a=t,p=[];for(p.push(a&127),a>>=7;a;){var c=a&127|128;p.push(c),a>>=7}this.writeBytes(p.reverse())}},i.prototype.writeChunk=function(t,a){this.writeString(t),this.writeUInt32(a.length),this.writeBytes(a)},Oe=e,Oe}var Xe;function Ut(){return Xe||(Xe=1,fe.parseMidi=Fn(),fe.writeMidi=Nn()),fe}var Me={},X={},et;function Bt(){if(et)return X;et=1,Object.defineProperty(X,"__esModule",{value:!0}),X.insert=X.search=void 0;function e(r,l,i){i===void 0&&(i="ticks");var t=0,a=r.length,p=a;if(a>0&&r[a-1][i]<=l)return a-1;for(;t<p;){var c=Math.floor(t+(p-t)/2),o=r[c],s=r[c+1];if(o[i]===l){for(var f=c;f<r.length;f++){var d=r[f];d[i]===l&&(c=f)}return c}else{if(o[i]<l&&s[i]>l)return c;o[i]>l?p=c:o[i]<l&&(t=c+1)}}return-1}X.search=e;function n(r,l,i){if(i===void 0&&(i="ticks"),r.length){var t=e(r,l[i],i);r.splice(t+1,0,l)}else r.push(l)}return X.insert=n,X}var tt;function Ae(){return tt||(tt=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.keySignatureKeys=void 0;var n=Bt(),r=new WeakMap;e.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var l=(function(){function i(t){var a=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",r.set(this,480),t){r.set(this,t.header.ticksPerBeat),t.tracks.forEach(function(c){c.forEach(function(o){o.meta&&(o.type==="timeSignature"?a.timeSignatures.push({ticks:o.absoluteTime,timeSignature:[o.numerator,o.denominator]}):o.type==="setTempo"?a.tempos.push({bpm:6e7/o.microsecondsPerBeat,ticks:o.absoluteTime}):o.type==="keySignature"&&a.keySignatures.push({key:e.keySignatureKeys[o.key+7],scale:o.scale===0?"major":"minor",ticks:o.absoluteTime}))})});var p=0;t.tracks[0].forEach(function(c){p+=c.deltaTime,c.meta&&(c.type==="trackName"?a.name=c.text:(c.type==="text"||c.type==="cuePoint"||c.type==="marker"||c.type==="lyrics")&&a.meta.push({text:c.text,ticks:p,type:c.type}))}),this.update()}}return i.prototype.update=function(){var t=this,a=0,p=0;this.tempos.sort(function(c,o){return c.ticks-o.ticks}),this.tempos.forEach(function(c,o){var s=o>0?t.tempos[o-1].bpm:t.tempos[0].bpm,f=c.ticks/t.ppq-p,d=60/s*f;c.time=d+a,a=c.time,p+=f}),this.timeSignatures.sort(function(c,o){return c.ticks-o.ticks}),this.timeSignatures.forEach(function(c,o){var s=o>0?t.timeSignatures[o-1]:t.timeSignatures[0],f=(c.ticks-s.ticks)/t.ppq,d=f/s.timeSignature[0]/(s.timeSignature[1]/4);s.measures=s.measures||0,c.measures=d+s.measures})},i.prototype.ticksToSeconds=function(t){var a=(0,n.search)(this.tempos,t);if(a!==-1){var p=this.tempos[a],c=p.time,o=(t-p.ticks)/this.ppq;return c+60/p.bpm*o}else{var s=t/this.ppq;return 60/120*s}},i.prototype.ticksToMeasures=function(t){var a=(0,n.search)(this.timeSignatures,t);if(a!==-1){var p=this.timeSignatures[a],c=(t-p.ticks)/this.ppq;return p.measures+c/(p.timeSignature[0]/p.timeSignature[1])/4}else return t/this.ppq/4},Object.defineProperty(i.prototype,"ppq",{get:function(){return r.get(this)},enumerable:!1,configurable:!0}),i.prototype.secondsToTicks=function(t){var a=(0,n.search)(this.tempos,t,"time");if(a!==-1){var p=this.tempos[a],c=p.time,o=t-c,s=o/(60/p.bpm);return Math.round(p.ticks+s*this.ppq)}else{var f=t/.5;return Math.round(f*this.ppq)}},i.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(t){return{bpm:t.bpm,ticks:t.ticks}}),timeSignatures:this.timeSignatures}},i.prototype.fromJSON=function(t){this.name=t.name,this.tempos=t.tempos.map(function(a){return Object.assign({},a)}),this.timeSignatures=t.timeSignatures.map(function(a){return Object.assign({},a)}),this.keySignatures=t.keySignatures.map(function(a){return Object.assign({},a)}),this.meta=t.meta.map(function(a){return Object.assign({},a)}),r.set(this,t.ppq),this.update()},i.prototype.setTempo=function(t){this.tempos=[{bpm:t,ticks:0}],this.update()},i})();e.Header=l})(Me)),Me}var se={},Fe={},nt;function Ct(){return nt||(nt=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(i,t){return i[e.controlChangeNames[t]]=t,i},{});var n=new WeakMap,r=new WeakMap,l=(function(){function i(t,a){n.set(this,a),r.set(this,t.controllerType),this.ticks=t.absoluteTime,this.value=t.value}return Object.defineProperty(i.prototype,"number",{get:function(){return r.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"time",{get:function(){var t=n.get(this);return t.ticksToSeconds(this.ticks)},set:function(t){var a=n.get(this);this.ticks=a.secondsToTicks(t)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},i})();e.ControlChange=l})(Fe)),Fe}var ie={},rt;function An(){if(rt)return ie;rt=1,Object.defineProperty(ie,"__esModule",{value:!0}),ie.createControlChanges=void 0;var e=Ct();function n(){return new Proxy({},{get:function(r,l){if(r[l])return r[l];if(e.controlChangeIds.hasOwnProperty(l))return r[e.controlChangeIds[l]]},set:function(r,l,i){return e.controlChangeIds.hasOwnProperty(l)?r[e.controlChangeIds[l]]=i:r[l]=i,!0}})}return ie.createControlChanges=n,ie}var oe={},at;function En(){if(at)return oe;at=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.PitchBend=void 0;var e=new WeakMap,n=(function(){function r(l,i){e.set(this,i),this.ticks=l.absoluteTime,this.value=l.value}return Object.defineProperty(r.prototype,"time",{get:function(){var l=e.get(this);return l.ticksToSeconds(this.ticks)},set:function(l){var i=e.get(this);this.ticks=i.secondsToTicks(l)},enumerable:!1,configurable:!0}),r.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},r})();return oe.PitchBend=n,oe}var le={},z={},st;function $n(){return st||(st=1,Object.defineProperty(z,"__esModule",{value:!0}),z.DrumKitByPatchID=z.InstrumentFamilyByID=z.instrumentByPatchID=void 0,z.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],z.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],z.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),z}var it;function Vn(){if(it)return le;it=1,Object.defineProperty(le,"__esModule",{value:!0}),le.Instrument=void 0;var e=$n(),n=new WeakMap,r=(function(){function l(i,t){if(this.number=0,n.set(this,t),this.number=0,i){var a=i.find(function(p){return p.type==="programChange"});a&&(this.number=a.programNumber)}}return Object.defineProperty(l.prototype,"name",{get:function(){return this.percussion?e.DrumKitByPatchID[this.number]:e.instrumentByPatchID[this.number]},set:function(i){var t=e.instrumentByPatchID.indexOf(i);t!==-1&&(this.number=t)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"family",{get:function(){return this.percussion?"drums":e.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"percussion",{get:function(){var i=n.get(this);return i.channel===9},enumerable:!1,configurable:!0}),l.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},l.prototype.fromJSON=function(i){this.number=i.number},l})();return le.Instrument=r,le}var ce={},ot;function Dn(){if(ot)return ce;ot=1,Object.defineProperty(ce,"__esModule",{value:!0}),ce.Note=void 0;function e(a){var p=Math.floor(a/12)-1;return n(a)+p.toString()}function n(a){var p=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],c=a%12;return p[c]}function r(a){var p=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return p.indexOf(a)}var l=(function(){var a=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,p={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(c){var o=a.exec(c),s=o[1],f=o[2],d=p[s.toLowerCase()];return d+(parseInt(f,10)+1)*12}})(),i=new WeakMap,t=(function(){function a(p,c,o){i.set(this,o),this.midi=p.midi,this.velocity=p.velocity,this.noteOffVelocity=c.velocity,this.ticks=p.ticks,this.durationTicks=c.ticks-p.ticks}return Object.defineProperty(a.prototype,"name",{get:function(){return e(this.midi)},set:function(p){this.midi=l(p)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(p){var c=p-this.octave;this.midi+=c*12},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"pitch",{get:function(){return n(this.midi)},set:function(p){this.midi=12*(this.octave+1)+r(p)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"duration",{get:function(){var p=i.get(this);return p.ticksToSeconds(this.ticks+this.durationTicks)-p.ticksToSeconds(this.ticks)},set:function(p){var c=i.get(this),o=c.secondsToTicks(this.time+p);this.durationTicks=o-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"time",{get:function(){var p=i.get(this);return p.ticksToSeconds(this.ticks)},set:function(p){var c=i.get(this);this.ticks=c.secondsToTicks(p)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"bars",{get:function(){var p=i.get(this);return p.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),a.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},a})();return ce.Note=t,ce}var lt;function ct(){if(lt)return se;lt=1,Object.defineProperty(se,"__esModule",{value:!0}),se.Track=void 0;var e=Bt(),n=Ct(),r=An(),l=En(),i=Vn(),t=Dn(),a=new WeakMap,p=(function(){function c(o,s){var f=this;if(this.name="",this.notes=[],this.controlChanges=(0,r.createControlChanges)(),this.pitchBends=[],a.set(this,s),o){var d=o.find(function(m){return m.type==="trackName"});this.name=d?d.text:""}if(this.instrument=new i.Instrument(o,this),this.channel=0,o){for(var u=o.filter(function(m){return m.type==="noteOn"}),v=o.filter(function(m){return m.type==="noteOff"}),g=function(){var m=u.shift();y.channel=m.channel;var w=v.findIndex(function(x){return x.noteNumber===m.noteNumber&&x.absoluteTime>=m.absoluteTime});if(w!==-1){var k=v.splice(w,1)[0];y.addNote({durationTicks:k.absoluteTime-m.absoluteTime,midi:m.noteNumber,noteOffVelocity:k.velocity/127,ticks:m.absoluteTime,velocity:m.velocity/127})}},y=this;u.length;)g();var b=o.filter(function(m){return m.type==="controller"});b.forEach(function(m){f.addCC({number:m.controllerType,ticks:m.absoluteTime,value:m.value/127})});var h=o.filter(function(m){return m.type==="pitchBend"});h.forEach(function(m){f.addPitchBend({ticks:m.absoluteTime,value:m.value/Math.pow(2,13)})});var S=o.find(function(m){return m.type==="endOfTrack"});this.endOfTrackTicks=S!==void 0?S.absoluteTime:void 0}}return c.prototype.addNote=function(o){var s=a.get(this),f=new t.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},s);return Object.assign(f,o),(0,e.insert)(this.notes,f,"ticks"),this},c.prototype.addCC=function(o){var s=a.get(this),f=new n.ControlChange({controllerType:o.number},s);return delete o.number,Object.assign(f,o),Array.isArray(this.controlChanges[f.number])||(this.controlChanges[f.number]=[]),(0,e.insert)(this.controlChanges[f.number],f,"ticks"),this},c.prototype.addPitchBend=function(o){var s=a.get(this),f=new l.PitchBend({},s);return Object.assign(f,o),(0,e.insert)(this.pitchBends,f,"ticks"),this},Object.defineProperty(c.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var o=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,s=0;s<this.notes.length-1;s++){var f=this.notes[s].time+this.notes[s].duration;o<f&&(o=f)}return o},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var o=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,s=0;s<this.notes.length-1;s++){var f=this.notes[s].ticks+this.notes[s].durationTicks;o<f&&(o=f)}return o},enumerable:!1,configurable:!0}),c.prototype.fromJSON=function(o){var s=this;this.name=o.name,this.channel=o.channel,this.instrument=new i.Instrument(void 0,this),this.instrument.fromJSON(o.instrument),o.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=o.endOfTrackTicks);for(var f in o.controlChanges)o.controlChanges[f]&&o.controlChanges[f].forEach(function(d){s.addCC({number:d.number,ticks:d.ticks,value:d.value})});o.notes.forEach(function(d){s.addNote({durationTicks:d.durationTicks,midi:d.midi,ticks:d.ticks,velocity:d.velocity})})},c.prototype.toJSON=function(){for(var o={},s=0;s<127;s++)this.controlChanges.hasOwnProperty(s)&&(o[s]=this.controlChanges[s].map(function(d){return d.toJSON()}));var f={channel:this.channel,controlChanges:o,pitchBends:this.pitchBends.map(function(d){return d.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(d){return d.toJSON()})};return this.endOfTrackTicks!==void 0&&(f.endOfTrackTicks=this.endOfTrackTicks),f},c})();return se.Track=p,se}var ee={};function jn(e){var n=[];return _t(e,n),n}function _t(e,n){for(var r=0;r<e.length;r++){var l=e[r];Array.isArray(l)?_t(l,n):n.push(l)}}const qn=Object.freeze(Object.defineProperty({__proto__:null,flatten:jn},Symbol.toStringTag,{value:"Module"})),Rn=on(qn);var dt;function Ln(){if(dt)return ee;dt=1;var e=ee&&ee.__spreadArray||function(b,h,S){if(S||arguments.length===2)for(var m=0,w=h.length,k;m<w;m++)(k||!(m in h))&&(k||(k=Array.prototype.slice.call(h,0,m)),k[m]=h[m]);return b.concat(k||Array.prototype.slice.call(h))};Object.defineProperty(ee,"__esModule",{value:!0}),ee.encode=void 0;var n=Ut(),r=Ae(),l=Rn;function i(b,h){return[{absoluteTime:b.ticks,channel:h,deltaTime:0,noteNumber:b.midi,type:"noteOn",velocity:Math.floor(b.velocity*127)},{absoluteTime:b.ticks+b.durationTicks,channel:h,deltaTime:0,noteNumber:b.midi,type:"noteOff",velocity:Math.floor(b.noteOffVelocity*127)}]}function t(b){return(0,l.flatten)(b.notes.map(function(h){return i(h,b.channel)}))}function a(b,h){return{absoluteTime:b.ticks,channel:h,controllerType:b.number,deltaTime:0,type:"controller",value:Math.floor(b.value*127)}}function p(b){for(var h=[],S=0;S<127;S++)b.controlChanges.hasOwnProperty(S)&&b.controlChanges[S].forEach(function(m){h.push(a(m,b.channel))});return h}function c(b,h){return{absoluteTime:b.ticks,channel:h,deltaTime:0,type:"pitchBend",value:b.value}}function o(b){var h=[];return b.pitchBends.forEach(function(S){h.push(c(S,b.channel))}),h}function s(b){return{absoluteTime:0,channel:b.channel,deltaTime:0,programNumber:b.instrument.number,type:"programChange"}}function f(b){return{absoluteTime:0,deltaTime:0,meta:!0,text:b,type:"trackName"}}function d(b){return{absoluteTime:b.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/b.bpm),type:"setTempo"}}function u(b){return{absoluteTime:b.ticks,deltaTime:0,denominator:b.timeSignature[1],meta:!0,metronome:24,numerator:b.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function v(b){var h=r.keySignatureKeys.indexOf(b.key);return{absoluteTime:b.ticks,deltaTime:0,key:h+7,meta:!0,scale:b.scale==="major"?0:1,type:"keySignature"}}function g(b){return{absoluteTime:b.ticks,deltaTime:0,meta:!0,text:b.text,type:b.type}}function y(b){var h={header:{format:1,numTracks:b.tracks.length+1,ticksPerBeat:b.header.ppq},tracks:e([e(e(e(e([{absoluteTime:0,deltaTime:0,meta:!0,text:b.header.name,type:"trackName"}],b.header.keySignatures.map(function(S){return v(S)}),!0),b.header.meta.map(function(S){return g(S)}),!0),b.header.tempos.map(function(S){return d(S)}),!0),b.header.timeSignatures.map(function(S){return u(S)}),!0)],b.tracks.map(function(S){return e(e(e([f(S.name),s(S)],t(S),!0),p(S),!0),o(S),!0)}),!0)};return h.tracks=h.tracks.map(function(S){S=S.sort(function(w,k){return w.absoluteTime-k.absoluteTime});var m=0;return S.forEach(function(w){w.deltaTime=w.absoluteTime-m,m=w.absoluteTime,delete w.absoluteTime}),S.push({deltaTime:0,meta:!0,type:"endOfTrack"}),S}),new Uint8Array((0,n.writeMidi)(h))}return ee.encode=y,ee}var ut;function Gn(){return ut||(ut=1,(function(e){var n=Y&&Y.__awaiter||function(f,d,u,v){function g(y){return y instanceof u?y:new u(function(b){b(y)})}return new(u||(u=Promise))(function(y,b){function h(w){try{m(v.next(w))}catch(k){b(k)}}function S(w){try{m(v.throw(w))}catch(k){b(k)}}function m(w){w.done?y(w.value):g(w.value).then(h,S)}m((v=v.apply(f,d||[])).next())})},r=Y&&Y.__generator||function(f,d){var u={label:0,sent:function(){if(y[0]&1)throw y[1];return y[1]},trys:[],ops:[]},v,g,y,b;return b={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function h(m){return function(w){return S([m,w])}}function S(m){if(v)throw new TypeError("Generator is already executing.");for(;u;)try{if(v=1,g&&(y=m[0]&2?g.return:m[0]?g.throw||((y=g.return)&&y.call(g),0):g.next)&&!(y=y.call(g,m[1])).done)return y;switch(g=0,y&&(m=[m[0]&2,y.value]),m[0]){case 0:case 1:y=m;break;case 4:return u.label++,{value:m[1],done:!1};case 5:u.label++,g=m[1],m=[0];continue;case 7:m=u.ops.pop(),u.trys.pop();continue;default:if(y=u.trys,!(y=y.length>0&&y[y.length-1])&&(m[0]===6||m[0]===2)){u=0;continue}if(m[0]===3&&(!y||m[1]>y[0]&&m[1]<y[3])){u.label=m[1];break}if(m[0]===6&&u.label<y[1]){u.label=y[1],y=m;break}if(y&&u.label<y[2]){u.label=y[2],u.ops.push(m);break}y[2]&&u.ops.pop(),u.trys.pop();continue}m=d.call(f,u)}catch(w){m=[6,w],g=0}finally{v=y=0}if(m[0]&5)throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}};Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.Track=e.Midi=void 0;var l=Ut(),i=Ae(),t=ct(),a=Ln(),p=(function(){function f(d){var u=this,v=null;if(d){var g=d instanceof ArrayBuffer?new Uint8Array(d):d;v=(0,l.parseMidi)(g),v.tracks.forEach(function(y){var b=0;y.forEach(function(h){b+=h.deltaTime,h.absoluteTime=b})}),v.tracks=s(v.tracks)}this.header=new i.Header(v),this.tracks=[],d&&(this.tracks=v.tracks.map(function(y){return new t.Track(y,u.header)}),v.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return f.fromUrl=function(d){return n(this,void 0,void 0,function(){var u,v;return r(this,function(g){switch(g.label){case 0:return[4,fetch(d)];case 1:return u=g.sent(),u.ok?[4,u.arrayBuffer()]:[3,3];case 2:return v=g.sent(),[2,new f(v)];case 3:throw new Error("Could not load '".concat(d,"'"))}})})},Object.defineProperty(f.prototype,"name",{get:function(){return this.header.name},set:function(d){this.header.name=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"duration",{get:function(){var d=this.tracks.map(function(u){return u.duration});return Math.max.apply(Math,d)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"durationTicks",{get:function(){var d=this.tracks.map(function(u){return u.durationTicks});return Math.max.apply(Math,d)},enumerable:!1,configurable:!0}),f.prototype.addTrack=function(){var d=new t.Track(void 0,this.header);return this.tracks.push(d),d},f.prototype.toArray=function(){return(0,a.encode)(this)},f.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(d){return d.toJSON()})}},f.prototype.fromJSON=function(d){var u=this;this.header=new i.Header,this.header.fromJSON(d.header),this.tracks=d.tracks.map(function(v){var g=new t.Track(void 0,u.header);return g.fromJSON(v),g})},f.prototype.clone=function(){var d=new f;return d.fromJSON(this.toJSON()),d},f})();e.Midi=p;var c=ct();Object.defineProperty(e,"Track",{enumerable:!0,get:function(){return c.Track}});var o=Ae();Object.defineProperty(e,"Header",{enumerable:!0,get:function(){return o.Header}});function s(f){for(var d=[],u=0;u<f.length;u++)for(var v=d.length,g=new Map,y=Array(16).fill(0),b=0,h=f[u];b<h.length;b++){var S=h[b],m=v,w=S.channel;if(w!==void 0){S.type==="programChange"&&(y[w]=S.programNumber);var k=y[w],x="".concat(k," ").concat(w);g.has(x)?m=g.get(x):(m=v+g.size,g.set(x,m))}d[m]||d.push([]),d[m].push(S)}return d}})(Y)),Y}var pt=Gn();const Hn="Drumcomputer Pattern Export",ft=e=>{const n=e.numberOfChannels,r=e.length*n*2+44,l=new ArrayBuffer(r),i=new DataView(l);let t=0;const a=s=>{for(let f=0;f<s.length;f+=1)i.setUint8(t+f,s.charCodeAt(f));t+=s.length},p=s=>{i.setUint16(t,s,!0),t+=2},c=s=>{i.setUint32(t,s,!0),t+=4};a("RIFF"),c(r-8),a("WAVE"),a("fmt "),c(16),p(1),p(n),c(e.sampleRate),c(e.sampleRate*n*2),p(n*2),p(16),a("data"),c(r-t-4);const o=[];for(let s=0;s<n;s+=1)o.push(e.getChannelData(s));for(;t<r;)for(let s=0;s<n;s+=1){const f=o[s];if(!f){t+=2;continue}const d=Math.floor((t-44)/(2*n)),u=f[d]??0,v=Math.max(-1,Math.min(1,u));i.setInt16(t,v<0?v*32768:v*32767,!0),t+=2}return l},he=e=>{const n=L(e.gridSpec),r={};return Object.entries(e.steps??{}).forEach(([l,i])=>{const t=Number(l);if(Number.isNaN(t))return;const a={};Object.entries(i??{}).forEach(([p,c])=>{const o=Number(p);if(Number.isNaN(o))return;const s={};Object.entries(c??{}).forEach(([f,d])=>{d&&(s[f]={velocity:{value:te(d.velocity?.value??ne)}})}),Object.keys(s).length>0&&(a[o]=s)}),Object.keys(a).length>0&&(r[t]=a)}),{...e,gridSpec:n,steps:r}},zn=(e,n)=>{const r={bars:1,division:16},l={},i=e.tracks[0];if(!i)return he({id:"imported-pattern",name:"Imported Pattern",gridSpec:r,steps:l});const a=e.header.ppq*4/r.division;return(i.notes??[]).forEach(c=>{const o=Math.round(c.ticks/a),s=Math.floor(o/r.division),f=o%r.division,d=n.noteMap[c.midi];if(!d)return;const u=l[s]??{},v=u[f]??{},g=typeof c.velocity=="number"?c.velocity:ne;v[d]={velocity:{value:te(g)}},u[f]=v,l[s]=u}),he({id:"imported-pattern",name:i.name??"Imported Pattern",gridSpec:r,steps:l})};function Jn(){const e=d=>{const u=he(d),v=new Blob([JSON.stringify(u,null,2)],{type:"application/json"});R.saveAs(v,`${u.name}.json`)},n=async d=>{try{const u=await d.text(),v=JSON.parse(u);return he(v)}catch(u){return console.error("Failed to import pattern",u),{id:`imported-${Date.now()}`,name:d.name,gridSpec:{bars:1,division:16},steps:{}}}},r=(d,u,v=Ne())=>{const g=new pt.Midi;g.header.setTempo(u);const y=g.addTrack(),b=g.header.ppq,h=b*4/d.gridSpec.division,S=d.gridSpec.bars*d.gridSpec.division;for(let x=0;x<S;x+=1){const T=Math.floor(x/d.gridSpec.division),M=x%d.gridSpec.division,N=d.steps[T]?.[M];N&&Object.entries(N).forEach(([j,J])=>{const G=j,Q=v.noteMapInverse?.[G]??Object.entries(v.noteMap).find(([,Se])=>Se===G)?.[0];if(typeof Q!="string"&&typeof Q!="number")return;const re=typeof Q=="string"?Number(Q):Q;typeof re=="number"&&y.addNote({midi:re,time:x*h/b,duration:h/b,velocity:J?.velocity?.value??1})})}const w=g.toArray().buffer,k=new Blob([w],{type:"audio/midi"});R.saveAs(k,`${d.name}.mid`)},l=async(d,u=Ne())=>{const v=await d.arrayBuffer(),g=new pt.Midi(v);return zn(g,u)},i=d=>{const u=d.currentScene,v=u?.patternIds??[],g=d.patterns[0]??{id:"pattern-1",name:"Pattern 1",gridSpec:{...D},steps:{}};let y=v[0]??d.selectedPatternId??g.id,b=v.length>1?1:0;const h=x=>d.patterns.find(T=>T.id===x)??g,S=()=>h(y),m=()=>{if(!u||v.length===0)return S();const x=v[b%v.length];return b=(b+1)%v.length,x&&(y=x),S()},w=S(),k=v.length>0?[...v]:[d.selectedPatternId??w.id];return{sceneId:u?.id??null,patternChain:k,initialPatternId:w.id,getPattern:S,advancePattern:m}},t=(d,u)=>{const v=[];return{schedule(g){v.push(g),v.sort((y,b)=>y.when-b.when)},run(){for(;v.length>0;){const g=v[0];if(!g||g.when>d)break;v.shift(),u(g.when),g.callback()}}}},a=d=>d.trim().toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"session",p=(d,u)=>{const v=new Set;return d.forEach(g=>{const y=u.find(b=>b.id===g);y&&Object.values(y.steps??{}).forEach(b=>{Object.values(b??{}).forEach(h=>{Object.keys(h??{}).forEach(S=>{v.add(S)})})})}),Array.from(v)};return{exportPattern:e,importPattern:n,exportMidi:r,importMidi:l,exportMidiData:d=>{const u=new Blob([Hn,JSON.stringify(d)],{type:"application/json"});R.saveAs(u,"sequence.mid.json")},exportAudio:async(d,u=44100,v={})=>{const g=$e(),y=gt(),b=xt(),h=Math.max(0,d),S=Math.max(1,Math.ceil(h*u)),m=v.seed??Date.now(),w=b.getFxSnapshot(),k=!1,x=new Map(b.sampleCache.value),T=i(y),M=T.getPattern(),N=L(M.gridSpec??g.gridSpec),j={seed:String(m),bpm:g.bpm,gridSpec:N,sceneId:T.sceneId,patternChain:T.patternChain,initialPatternId:T.initialPatternId,durationSec:h},J=a(y.currentScene?.name??M.name??"drum-session"),G=p(T.patternChain,y.patterns),Q=v.stems?G.filter(W=>x.has(W)):[],re=async(W,qe=!1)=>{const q=new OfflineAudioContext(2,S,u),ae=q.createGain();ae.gain.value=.8,ae.connect(q.destination);const Ie=It(q);wt(Ie,ae);const Dt=kt(m);Pt(q,Ie,w,Dt);const jt=new Map(x),qt=k,Rt=[],Lt={trigger({padId:H,when:Kt,velocity:Zt=1}){if(W&&H!==W)return;const He=jt.get(H);if(!He)return;const xe=q.createBufferSource();xe.buffer=He;const Te=q.createGain();Te.gain.value=Zt,xe.connect(Te),Te.connect(Ie.fxInput),xe.start(Kt)}};let we=0;const Gt={ctx:Tt(q,!0).ctx,isOffline:!0,now:()=>we},Re=t(h,H=>{we=H}),Pe=i(y),Ht=Pe.getPattern(),zt=L(Ht.gridSpec??g.gridSpec),Jt=_(0),Wt=_([]),Le={loop:g.loop,bpm:g.bpm,gridSpec:zt,setCurrentStep:()=>{},setGridSpec(H){Le.gridSpec=L(H)}},Ge=Le;return Ve({clock:Gt,scheduler:Re,audio:Lt,transport:Ge,getPattern:()=>Pe.getPattern(),currentStep:Jt,pendingSteps:Wt,onPatternBoundary:()=>{const H=Pe.advancePattern();return Ge.setGridSpec(H.gridSpec),H}},0),Re.run(),we=h,{audioBuffer:await q.startRendering(),debugEvents:qt?Rt:void 0}},Se=await re(void 0,!0),De=new Blob([ft(Se.audioBuffer)],{type:"audio/wav"});R.saveAs(De,"mixdown.wav");const ke={};for(const W of Q){const qe=await re(W),q=new Blob([ft(qe.audioBuffer)],{type:"audio/wav"}),ae=`${J}_${W}.wav`;ke[W]={fileName:ae,blob:q}}const je={audioBlob:De,metadata:j};return Object.keys(ke).length>0&&(je.stems=ke),je},exportSoundbank:(d,u)=>{const v=Object.entries(d.pads).reduce((y,[b,h])=>(h&&(y[b]={id:h.id,name:h.name,format:h.format}),y),{}),g={bank:{...d,pads:v},samples:u.map(y=>{const b={id:y.id,name:y.name};return y.format&&(b.format=y.format),b})};R.saveAs(new Blob([JSON.stringify(g,null,2)],{type:"application/json"}),`${d.name}-manifest.json`),u.forEach(y=>{y.blob&&R.saveAs(y.blob,y.name)})},importSoundbank:async(d,u)=>{try{const v=await d.text(),g=JSON.parse(v),y=new Map(u.map(m=>[m.name,m])),b=g.samples.map(m=>{const w=y.get(m.name);return w?{...m,blob:w}:{...m}}),h={};return Object.entries(g.bank.pads??{}).forEach(([m,w])=>{const k=b.find(x=>x.id===w.id);k&&(h[m]=k)}),{bank:{...g.bank,pads:h},samples:b}}catch(v){return console.error("Failed to import soundbank",v),{bank:{id:"invalid-bank",name:d.name,pads:{},createdAt:Date.now(),updatedAt:Date.now()},samples:[]}}}}}function Wn(){const e=_({supportsWebMIDI:!1,supportsAudioInput:!1}),n=()=>{e.value={supportsWebMIDI:typeof navigator<"u"&&"requestMIDIAccess"in navigator,supportsAudioInput:typeof navigator<"u"&&!!navigator.mediaDevices?.getUserMedia}};return n(),{capabilities:e,evaluate:n}}const Kn=A({name:"TransportBar",props:{bpm:{type:Number,required:!0},isPlaying:{type:Boolean,required:!0},loop:{type:Boolean,required:!0},division:{type:Number,required:!0},divisions:{type:Array,required:!0}},emits:["play","stop","bpm:update","loop:update","division:update"],computed:{divisionItems(){return this.divisions.map(e=>({title:`1/${e}`,value:e}))}},methods:{onBpm(e){const n=Number(e);Number.isNaN(n)||this.$emit("bpm:update",n)},onDivision(e){e&&this.$emit("division:update",e)},toggleLoop(){this.$emit("loop:update",!this.loop)}}}),Zn={class:"transport-controls"},Qn={class:"transport-parameters"};function Yn(e,n,r,l,i,t){const a=B("v-icon"),p=B("v-btn"),c=B("v-text-field"),o=B("v-select"),s=B("v-app-bar");return C(),E(s,{class:"transport-bar",dense:"",flat:""},{default:P(()=>[U("div",Zn,[I(p,{icon:"",disabled:e.isPlaying,color:"primary",onClick:n[0]||(n[0]=f=>e.$emit("play")),"aria-label":"Play"},{default:P(()=>[I(a,null,{default:P(()=>[...n[2]||(n[2]=[O("mdi-play",-1)])]),_:1})]),_:1},8,["disabled"]),I(p,{icon:"",disabled:!e.isPlaying,color:"error",onClick:n[1]||(n[1]=f=>e.$emit("stop")),"aria-label":"Stop"},{default:P(()=>[I(a,null,{default:P(()=>[...n[3]||(n[3]=[O("mdi-stop",-1)])]),_:1})]),_:1},8,["disabled"])]),U("div",Qn,[I(c,{class:"bpm-input",dense:"",type:"number",label:"BPM","model-value":e.bpm,"onUpdate:modelValue":e.onBpm,min:"40",max:"240","hide-details":""},null,8,["model-value","onUpdate:modelValue"]),I(o,{class:"division-select",dense:"",label:"Division",items:e.divisionItems,"item-title":"title","item-value":"value","model-value":e.division,"onUpdate:modelValue":e.onDivision,"hide-details":""},null,8,["items","model-value","onUpdate:modelValue"]),I(p,{class:"loop-toggle",icon:"",color:e.loop?"cyan":"grey",onClick:e.toggleLoop,"aria-label":"Loop"},{default:P(()=>[I(a,{class:be({"mdi-spin":e.loop})},{default:P(()=>[...n[4]||(n[4]=[O("mdi-repeat",-1)])]),_:1},8,["class"])]),_:1},8,["color","onClick"])])]),_:1})}const Ot=Object.assign($(Kn,[["render",Yn],["__scopeId","data-v-ff233923"]]),{__name:"TransportBar"}),Xn=A({name:"PadCell",props:{padId:{type:String,required:!0},label:{type:String,required:!0},isSelected:{type:Boolean,default:!1},isTriggered:{type:Boolean,default:!1},isPlaying:{type:Boolean,default:!1}},emits:["pad:down","pad:select"],computed:{padClasses(){return{"is-selected":this.isSelected,"is-triggered":this.isTriggered,"is-playing":this.isPlaying}}},methods:{handleDown(){this.$emit("pad:down",this.padId)},handleSelect(){this.$emit("pad:select",this.padId)}}}),er={class:"pad-label"};function tr(e,n,r,l,i,t){return C(),F("button",{class:be(["pad-cell",e.padClasses]),type:"button",onPointerdown:n[0]||(n[0]=(...a)=>e.handleDown&&e.handleDown(...a)),onClick:n[1]||(n[1]=(...a)=>e.handleSelect&&e.handleSelect(...a)),onKeydown:[n[2]||(n[2]=ze(Je((...a)=>e.handleDown&&e.handleDown(...a),["prevent"]),["enter"])),n[3]||(n[3]=ze(Je((...a)=>e.handleDown&&e.handleDown(...a),["prevent"]),["space"]))],"aria-pressed":"isSelected"},[U("span",er,V(e.label),1)],34)}const Mt=Object.assign($(Xn,[["render",tr],["__scopeId","data-v-27af9f88"]]),{__name:"PadCell"}),nr=A({name:"PadGrid",components:{PadCell:Mt},props:{pads:{type:Array,required:!0},selectedPad:{type:String,default:null},padStates:{type:Object,default:()=>({})}},emits:["pad:down","pad:select"],methods:{padLabel(e){return this.padStates[e]?.label??e.toUpperCase()}}}),rr={class:"pad-grid"};function ar(e,n,r,l,i,t){const a=Mt;return C(),F("div",rr,[(C(!0),F(ye,null,ge(e.pads,p=>(C(),E(a,{key:p,"pad-id":p,label:e.padLabel(p),"is-selected":e.selectedPad===p,"is-triggered":e.padStates[p]?.isTriggered??!1,"is-playing":e.padStates[p]?.isPlaying??!1,"onPad:down":n[0]||(n[0]=c=>e.$emit("pad:down",c)),"onPad:select":n[1]||(n[1]=c=>e.$emit("pad:select",c))},null,8,["pad-id","label","is-selected","is-triggered","is-playing"]))),128))])}const Ft=Object.assign($(nr,[["render",ar],["__scopeId","data-v-9685e4f8"]]),{__name:"PadGrid"}),sr=A({name:"StepCell",props:{displayLabel:{type:String,required:!0},isActive:{type:Boolean,default:!1},isAccent:{type:Boolean,default:!1},isCurrent:{type:Boolean,default:!1}},emits:["cell:toggle"],computed:{cellClasses(){return{"is-active":this.isActive,"is-accent":this.isAccent,"is-current":this.isCurrent}}}}),ir={class:"step-tag"};function or(e,n,r,l,i,t){return C(),F("button",{class:be(["step-cell",e.cellClasses]),type:"button",onClick:n[0]||(n[0]=a=>e.$emit("cell:toggle")),"aria-pressed":"isActive"},[U("span",ir,V(e.displayLabel),1)],2)}const Nt=Object.assign($(sr,[["render",or],["__scopeId","data-v-2de6ef11"]]),{__name:"StepCell"}),lr=A({name:"PlayheadOverlay",props:{currentStep:{type:Number,required:!0},totalSteps:{type:Number,required:!0},isPlaying:{type:Boolean,required:!0}},computed:{overlayStyle(){const e=Math.max(this.totalSteps,1),n=(this.currentStep%e+e)%e,r=100/e,l=n*r;return{width:`${r}%`,left:`${l}%`}}}});function cr(e,n,r,l,i,t){return C(),F("div",{class:be(["playhead-overlay",{"is-active":e.isPlaying}]),style:rn(e.overlayStyle)},null,6)}const At=Object.assign($(lr,[["render",cr],["__scopeId","data-v-a839da9e"]]),{__name:"PlayheadOverlay"}),dr=A({name:"StepGrid",components:{StepCell:Nt,PlayheadOverlay:At},props:{gridSpec:{type:Object,required:!0},steps:{type:Object,required:!0},selectedPad:{type:String,default:null},currentStep:{type:Number,required:!0},isPlaying:{type:Boolean,required:!0}},emits:["step:toggle"],computed:{totalSteps(){return this.gridSpec.bars*this.gridSpec.division},currentStepNormalized(){const e=Math.max(this.totalSteps,1);return(this.currentStep%e+e)%e}},methods:{emitToggle(e){const n=Math.floor(e/this.gridSpec.division),r=e%this.gridSpec.division;this.selectedPad&&this.$emit("step:toggle",{barIndex:n,stepInBar:r,padId:this.selectedPad})},velocityAt(e){if(!this.selectedPad)return;const n=Math.floor(e/this.gridSpec.division),r=e%this.gridSpec.division;return this.steps[n]?.[r]?.[this.selectedPad]?.velocity?.value},isActive(e){return!!this.velocityAt(e)},isAccent(e){const n=this.velocityAt(e);return n!==void 0&&n>=vt-.01},isCurrent(e){return e===this.currentStepNormalized}}}),ur={class:"step-grid-shell"},pr={class:"step-row"};function fr(e,n,r,l,i,t){const a=Nt,p=At;return C(),F("div",ur,[U("div",pr,[(C(!0),F(ye,null,ge(e.totalSteps,c=>(C(),E(a,{key:c,"display-label":String(c),"is-active":e.isActive(c-1),"is-accent":e.isAccent(c-1),"is-current":e.isCurrent(c-1),"onCell:toggle":o=>e.emitToggle(c-1)},null,8,["display-label","is-active","is-accent","is-current","onCell:toggle"]))),128)),e.totalSteps>0?(C(),E(p,{key:0,"current-step":e.currentStepNormalized,"total-steps":e.totalSteps,"is-playing":e.isPlaying},null,8,["current-step","total-steps","is-playing"])):K("",!0)])])}const Et=Object.assign($(dr,[["render",fr],["__scopeId","data-v-eaa17c3c"]]),{__name:"StepGrid"}),mr=[{label:"Sound",value:"sound"},{label:"FX",value:"fx"},{label:"Patterns",value:"patterns"},{label:"Export",value:"export"}],hr=A({name:"TabPanel",props:{modelValue:{type:String,default:"sound"}},emits:["update:modelValue"],computed:{internalTab:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},tabs(){return mr}}}),vr={class:"drawer-shell"};function br(e,n,r,l,i,t){const a=B("v-tab"),p=B("v-tabs"),c=B("v-tabs-window-item"),o=B("v-tabs-window");return C(),F("div",vr,[I(p,{class:"drawer-tabs",modelValue:e.internalTab,"onUpdate:modelValue":n[0]||(n[0]=s=>e.internalTab=s),density:"comfortable",variant:"text"},{default:P(()=>[(C(!0),F(ye,null,ge(e.tabs,s=>(C(),E(a,{key:s.value,value:s.value},{default:P(()=>[O(V(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),I(o,{class:"drawer-window",modelValue:e.internalTab,"onUpdate:modelValue":n[1]||(n[1]=s=>e.internalTab=s)},{default:P(()=>[I(c,{value:"sound"},{default:P(()=>[de(e.$slots,"sound",{},void 0,!0)]),_:3}),I(c,{value:"fx"},{default:P(()=>[de(e.$slots,"fx",{},void 0,!0)]),_:3}),I(c,{value:"patterns"},{default:P(()=>[de(e.$slots,"patterns",{},void 0,!0)]),_:3}),I(c,{value:"export"},{default:P(()=>[de(e.$slots,"export",{},void 0,!0)]),_:3})]),_:3},8,["modelValue"])])}const $t=Object.assign($(hr,[["render",br],["__scopeId","data-v-2166decf"]]),{__name:"TabPanel"}),yr=A({name:"SoundPanel",props:{banks:{type:Array,required:!0},selectedBankId:{type:String,default:null}},emits:["bank:select","pad:replace"],data(){return{padTarget:"pad1"}},computed:{bankItems(){return this.banks.map(e=>({title:e.name,value:e.id}))},padItems(){return Array.from({length:16},(e,n)=>{const r=`pad${n+1}`;return{title:r.toUpperCase(),value:r}})},currentSampleLabel(){return this.banks.find(r=>r.id===this.selectedBankId)?.pads?.[this.padTarget]?.name??"Default"}},methods:{selectBank(e){this.$emit("bank:select",e)},triggerFile(){this.$refs.fileInput?.click()},onFileChange(e){const n=e.target,r=n?.files;if(!r||r.length===0)return;const l=r[0];this.$emit("pad:replace",{padId:this.padTarget,file:l}),n&&(n.value="")}}}),gr={class:"panel-shell"},Sr={class:"panel-body"},kr={class:"current-sample"};function Ir(e,n,r,l,i,t){const a=B("v-select"),p=B("v-btn");return C(),F("div",gr,[n[3]||(n[3]=U("div",{class:"panel-header"},"Sound",-1)),U("div",Sr,[I(a,{label:"Bank",dense:"",items:e.bankItems,"item-title":"title","item-value":"value","model-value":e.selectedBankId,"onUpdate:modelValue":e.selectBank,"hide-details":""},null,8,["items","model-value","onUpdate:modelValue"]),I(a,{label:"Pad",dense:"",items:e.padItems,"item-title":"title","item-value":"value",modelValue:e.padTarget,"onUpdate:modelValue":n[0]||(n[0]=c=>e.padTarget=c),"hide-details":""},null,8,["items","modelValue"]),U("p",kr,"Label: "+V(e.currentSampleLabel),1),U("input",{class:"d-none",ref:"fileInput",type:"file",accept:"audio/*",onChange:n[1]||(n[1]=(...c)=>e.onFileChange&&e.onFileChange(...c))},null,544),I(p,{class:"mt-3",color:"primary",block:"",onClick:e.triggerFile},{default:P(()=>[...n[2]||(n[2]=[O("Replace sample",-1)])]),_:1},8,["onClick"])])])}const wr=Object.assign($(yr,[["render",Ir],["__scopeId","data-v-6f113482"]]),{__name:"PanelsSoundPanel"}),Pr=A({name:"FxPanel",props:{fxSettings:{type:Object,required:!0}},emits:["fx:update"],data(){return{activeSlot:"filter",localFx:{...this.fxSettings}}},watch:{fxSettings:{deep:!0,handler(e){this.localFx={...e,filter:{...e.filter},drive:{...e.drive},reverb:{...e.reverb}}}}},methods:{emitFx(){this.$emit("fx:update",{filter:{...this.localFx.filter},drive:{...this.localFx.drive},reverb:{...this.localFx.reverb}})},toggleFilter(e){this.localFx.filter.enabled=e,this.emitFx()},setFilterFreq(e){this.localFx.filter.frequency=e,this.emitFx()},setFilterQ(e){this.localFx.filter.q=e,this.emitFx()},toggleDrive(e){this.localFx.drive.enabled=e,this.emitFx()},setDriveAmount(e){this.localFx.drive.amount=e,this.emitFx()},toggleReverb(e){this.localFx.reverb.enabled=e,this.emitFx()},setReverbMix(e){this.localFx.reverb.mix=e,this.emitFx()}}}),xr={class:"panel-shell"};function Tr(e,n,r,l,i,t){const a=B("v-expansion-panel-title"),p=B("v-switch"),c=B("v-slider"),o=B("v-expansion-panel-text"),s=B("v-expansion-panel"),f=B("v-expansion-panels");return C(),F("div",xr,[n[6]||(n[6]=U("div",{class:"panel-header"},"FX",-1)),I(f,{class:"fx-panels",modelValue:e.activeSlot,"onUpdate:modelValue":n[0]||(n[0]=d=>e.activeSlot=d),accordion:""},{default:P(()=>[I(s,{value:"filter"},{default:P(()=>[I(a,null,{default:P(()=>[...n[1]||(n[1]=[O("Filter",-1)])]),_:1}),I(o,null,{default:P(()=>[I(p,{label:"Enabled",dense:"","model-value":e.localFx.filter.enabled,"onUpdate:modelValue":e.toggleFilter},null,8,["model-value","onUpdate:modelValue"]),e.localFx.filter.enabled?(C(),E(c,{key:0,dense:"",label:"Cutoff","hide-details":"",min:"200",max:"18000",step:"50","thumb-label":"","model-value":e.localFx.filter.frequency,"onUpdate:modelValue":e.setFilterFreq},null,8,["model-value","onUpdate:modelValue"])):K("",!0),e.localFx.filter.enabled?(C(),E(c,{key:1,dense:"",label:"Resonance (Q)","hide-details":"",min:"0.1",max:"12",step:"0.1","thumb-label":"","model-value":e.localFx.filter.q,"onUpdate:modelValue":e.setFilterQ},null,8,["model-value","onUpdate:modelValue"])):K("",!0)]),_:1})]),_:1}),I(s,{value:"drive"},{default:P(()=>[I(a,null,{default:P(()=>[...n[2]||(n[2]=[O("Drive",-1)])]),_:1}),I(o,null,{default:P(()=>[I(p,{label:"Enabled",dense:"","model-value":e.localFx.drive.enabled,"onUpdate:modelValue":e.toggleDrive},null,8,["model-value","onUpdate:modelValue"]),e.localFx.drive.enabled?(C(),E(c,{key:0,dense:"",label:"Amount","hide-details":"",min:"0",max:"1",step:"0.05","thumb-label":"","model-value":e.localFx.drive.amount,"onUpdate:modelValue":e.setDriveAmount},null,8,["model-value","onUpdate:modelValue"])):K("",!0)]),_:1})]),_:1}),I(s,{value:"reverb"},{default:P(()=>[I(a,null,{default:P(()=>[...n[3]||(n[3]=[O("Reverb",-1)])]),_:1}),I(o,null,{default:P(()=>[I(p,{label:"Enabled",dense:"","model-value":e.localFx.reverb.enabled,"onUpdate:modelValue":e.toggleReverb},null,8,["model-value","onUpdate:modelValue"]),e.localFx.reverb.enabled?(C(),E(c,{key:0,dense:"",label:"Mix","hide-details":"",min:"0",max:"0.6",step:"0.02","thumb-label":"","model-value":e.localFx.reverb.mix,"onUpdate:modelValue":e.setReverbMix},null,8,["model-value","onUpdate:modelValue"])):K("",!0)]),_:1})]),_:1}),I(s,{value:"routing"},{default:P(()=>[I(a,null,{default:P(()=>[...n[4]||(n[4]=[O("Routing",-1)])]),_:1}),I(o,null,{default:P(()=>[...n[5]||(n[5]=[U("p",null,"Subtle master shaping slot. No additional controls yet.",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const Ur=Object.assign($(Pr,[["render",Tr],["__scopeId","data-v-54c0e84f"]]),{__name:"PanelsFxPanel"}),Br=A({name:"PatternsPanel",props:{patterns:{type:Array,required:!0},selectedPatternId:{type:String,required:!1},scenes:{type:Array,required:!0},activeSceneId:{type:String,default:null}},emits:["pattern:add","pattern:select","pattern:rename","pattern:undo","pattern:redo","scene:add","scene:update","scene:select"],data(){return{newPatternName:"",renameValue:"",sceneName:"",scenePatternIds:[]}},computed:{patternItems(){return this.patterns.map(e=>({title:e.name,value:e.id}))},sceneItems(){return[{title:"None",value:null},...this.scenes.map(e=>({title:e.name,value:e.id}))]},currentScene(){return this.scenes.find(e=>e.id===this.activeSceneId)??null},currentPattern(){return this.patterns.find(e=>e.id===this.selectedPatternId)??null}},watch:{currentScene:{immediate:!0,handler(e){this.sceneName=e?.name??"",this.scenePatternIds=[...e?.patternIds??[]]}},currentPattern:{immediate:!0,handler(e){this.renameValue=e?.name??""}}},methods:{addPattern(){this.$emit("pattern:add",{name:this.newPatternName.trim()||void 0}),this.newPatternName=""},handlePatternSelect(e){e&&this.$emit("pattern:select",e)},emitPatternUndo(){this.$emit("pattern:undo")},emitPatternRedo(){this.$emit("pattern:redo")},updateRenameValue(e){this.renameValue=e},setNewPatternName(e){this.newPatternName=e},submitRename(){this.currentPattern&&this.renameValue.trim().length>0&&this.$emit("pattern:rename",{id:this.currentPattern.id,name:this.renameValue.trim()})},selectScene(e){this.$emit("scene:select",e)},updateSceneName(e){this.sceneName=e,this.emitSceneUpdate()},setScenePatternIds(e){this.scenePatternIds=e,this.emitSceneUpdate()},emitSceneUpdate(){this.currentScene&&this.$emit("scene:update",{id:this.currentScene.id,name:this.sceneName.trim()||this.currentScene.name,patternIds:this.scenePatternIds})},addScene(){this.$emit("scene:add",{name:this.sceneName.trim()||"Scene",patternIds:this.scenePatternIds})}}}),Cr={class:"panel-shell"},_r={class:"panel-body"};function Or(e,n,r,l,i,t){const a=B("v-select"),p=B("v-text-field"),c=B("v-btn"),o=B("v-col"),s=B("v-row"),f=B("v-combobox");return C(),F("div",Cr,[n[4]||(n[4]=U("div",{class:"panel-header"},"Patterns",-1)),U("div",_r,[I(s,null,{default:P(()=>[I(o,{cols:"12",md:"6"},{default:P(()=>[I(a,{label:"Current Pattern",dense:"",items:e.patternItems,"item-title":"title","item-value":"value","model-value":e.selectedPatternId,"onUpdate:modelValue":e.handlePatternSelect,"hide-details":""},null,8,["items","model-value","onUpdate:modelValue"]),I(p,{label:"Rename Pattern",dense:"","model-value":e.renameValue,placeholder:e.currentPattern?.name||"Pattern","onUpdate:modelValue":e.updateRenameValue,onChange:e.submitRename,"hide-details":""},null,8,["model-value","placeholder","onUpdate:modelValue","onChange"]),I(p,{label:"New Pattern Name",dense:"","model-value":e.newPatternName,"onUpdate:modelValue":e.setNewPatternName,"hide-details":""},null,8,["model-value","onUpdate:modelValue"]),I(c,{class:"mt-1",color:"primary",block:"",onClick:e.addPattern},{default:P(()=>[...n[0]||(n[0]=[O("Add Pattern",-1)])]),_:1},8,["onClick"]),I(s,{class:"mt-2",dense:""},{default:P(()=>[I(o,{cols:"6"},{default:P(()=>[I(c,{color:"secondary",block:"",onClick:e.emitPatternUndo},{default:P(()=>[...n[1]||(n[1]=[O("Undo",-1)])]),_:1},8,["onClick"])]),_:1}),I(o,{cols:"6"},{default:P(()=>[I(c,{color:"secondary",block:"",variant:"outlined",onClick:e.emitPatternRedo},{default:P(()=>[...n[2]||(n[2]=[O("Redo",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),I(o,{cols:"12",md:"6"},{default:P(()=>[I(a,{label:"Active Scene",dense:"",items:e.sceneItems,"item-title":"title","item-value":"value","model-value":e.activeSceneId,"onUpdate:modelValue":e.selectScene,"hide-details":"",clearable:""},null,8,["items","model-value","onUpdate:modelValue"]),I(p,{label:"Scene Name",dense:"","model-value":e.sceneName,"onUpdate:modelValue":e.updateSceneName,onChange:e.emitSceneUpdate,"hide-details":""},null,8,["model-value","onUpdate:modelValue","onChange"]),I(f,{label:"Pattern Chain",dense:"",clearable:"",multiple:"",chips:"",items:e.patternItems,"item-title":"title","item-value":"value","model-value":e.scenePatternIds,"onUpdate:modelValue":e.setScenePatternIds,"hide-details":""},null,8,["items","model-value","onUpdate:modelValue"]),I(c,{class:"mt-1",color:"secondary",block:"",onClick:e.addScene},{default:P(()=>[...n[3]||(n[3]=[O("Add Scene",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})])])}const Mr=Object.assign($(Br,[["render",Or],["__scopeId","data-v-8034c803"]]),{__name:"PanelsPatternsPanel"}),Fr=A({name:"ExportPanel",props:{isExporting:{type:Boolean,required:!0},exportError:{type:String,default:null},exportMetadata:{type:Object,default:null},audioBlob:{type:Object,default:null},hasZipArtifacts:{type:Boolean,required:!0},stemEntries:{type:Array,default:()=>[]}},emits:["export","download:mixdown","download:zip","download:stem","download:stems"],computed:{metadata(){return this.exportMetadata},gridLabel(){const e=this.exportMetadata?.gridSpec;return e?`${e.bars} bar${e.bars===1?"":"s"}  1/${e.division}`:""},formattedDuration(){const e=this.exportMetadata?.durationSec;return typeof e!="number"?"":`${e.toFixed(2)}s`}}}),Nr={class:"panel-shell"},Ar={class:"panel-body"},Er={class:"metadata-grid"},$r={class:"metadata-row"},Vr={class:"value"},Dr={class:"metadata-row"},jr={class:"value"},qr={class:"metadata-row"},Rr={class:"value"},Lr={class:"metadata-row"},Gr={class:"value"},Hr={key:1,class:"stem-header"};function zr(e,n,r,l,i,t){const a=B("v-btn"),p=B("v-alert"),c=B("v-divider"),o=B("v-list-item-title"),s=B("v-list-item-subtitle"),f=B("v-list-item"),d=B("v-list");return C(),F("div",Nr,[n[14]||(n[14]=U("div",{class:"panel-header"},"Export",-1)),U("div",Ar,[I(a,{color:"primary",block:"",loading:e.isExporting,disabled:e.isExporting,onClick:n[0]||(n[0]=u=>e.$emit("export"))},{default:P(()=>[...n[4]||(n[4]=[O("Export mixdown",-1)])]),_:1},8,["loading","disabled"]),e.exportError?(C(),E(p,{key:0,class:"mt-2",type:"error",dense:""},{default:P(()=>[O(V(e.exportError),1)]),_:1})):K("",!0),U("div",Er,[U("div",$r,[n[5]||(n[5]=U("span",{class:"label"},"Seed",-1)),U("span",Vr,V(e.metadata?.seed??""),1)]),U("div",Dr,[n[6]||(n[6]=U("span",{class:"label"},"BPM",-1)),U("span",jr,V(e.metadata?.bpm??""),1)]),U("div",qr,[n[7]||(n[7]=U("span",{class:"label"},"Duration",-1)),U("span",Rr,V(e.formattedDuration),1)]),U("div",Lr,[n[8]||(n[8]=U("span",{class:"label"},"Grid",-1)),U("span",Gr,V(e.gridLabel),1)])]),I(a,{class:"mt-2",color:"secondary",block:"",disabled:!e.audioBlob||e.isExporting,onClick:n[1]||(n[1]=u=>e.$emit("download:mixdown"))},{default:P(()=>[...n[9]||(n[9]=[O("Download WAV",-1)])]),_:1},8,["disabled"]),I(a,{class:"mt-2",color:"secondary",block:"",disabled:!e.hasZipArtifacts||e.isExporting,variant:"outlined",onClick:n[2]||(n[2]=u=>e.$emit("download:zip"))},{default:P(()=>[...n[10]||(n[10]=[O("Download ZIP bundle",-1)])]),_:1},8,["disabled"]),I(c,{class:"my-3"}),e.stemEntries.length>0?(C(),F("div",Hr,[n[12]||(n[12]=U("span",null,"Stem exports",-1)),I(a,{class:"ml-auto",text:"",small:"",disabled:e.isExporting,onClick:n[3]||(n[3]=u=>e.$emit("download:stems"))},{default:P(()=>[...n[11]||(n[11]=[O("Download all",-1)])]),_:1},8,["disabled"])])):K("",!0),e.stemEntries.length>0?(C(),E(d,{key:2,density:"compact"},{default:P(()=>[(C(!0),F(ye,null,ge(e.stemEntries,u=>(C(),E(f,{key:u.padId},{append:P(()=>[I(a,{text:"",small:"",disabled:e.isExporting,onClick:v=>e.$emit("download:stem",u.padId)},{default:P(()=>[...n[13]||(n[13]=[O("Download",-1)])]),_:1},8,["disabled","onClick"])]),default:P(()=>[I(o,null,{default:P(()=>[O(V(u.label),1)]),_:2},1024),I(s,null,{default:P(()=>[O(V(u.fileName),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})):K("",!0)])])}const Jr=Object.assign($(Fr,[["render",zr],["__scopeId","data-v-5c4f0f73"]]),{__name:"PanelsExportPanel"}),Wr=new TextEncoder,Kr=(()=>{const e=new Uint32Array(256);for(let n=0;n<256;n+=1){let r=n;for(let l=0;l<8;l+=1)r=r&1?3988292384^r>>>1:r>>>1;e[n]=r>>>0}return e})(),Zr=e=>{let n=4294967295;for(let r=0;r<e.length;r+=1){const l=e[r]??0;n=(Kr[(n^l)&255]??0)^n>>>8}return(n^4294967295)>>>0},Qr=e=>{const n=[],r=[];let l=0,i=0;for(const c of e){const{name:o,data:s}=c,f=Zr(s),d=Wr.encode(o),u=new ArrayBuffer(30+d.length),v=new DataView(u);v.setUint32(0,67324752,!0),v.setUint16(4,20,!0),v.setUint16(6,0,!0),v.setUint16(8,0,!0),v.setUint16(10,0,!0),v.setUint16(12,0,!0),v.setUint32(14,f,!0),v.setUint32(18,s.length,!0),v.setUint32(22,s.length,!0),v.setUint16(26,d.length,!0),v.setUint16(28,0,!0);const g=new Uint8Array(u);g.set(d,30),n.push(u);let y;s.buffer instanceof ArrayBuffer&&!(s.buffer instanceof SharedArrayBuffer)?y=s.buffer.slice(0,s.byteLength):y=new Uint8Array(s).buffer.slice(0),n.push(y);const b=new ArrayBuffer(46+d.length),h=new DataView(b);h.setUint32(0,33639248,!0),h.setUint16(4,20,!0),h.setUint16(6,20,!0),h.setUint16(8,0,!0),h.setUint16(10,0,!0),h.setUint16(12,0,!0),h.setUint16(14,0,!0),h.setUint32(16,f,!0),h.setUint32(20,s.length,!0),h.setUint32(24,s.length,!0),h.setUint16(28,d.length,!0),h.setUint16(30,0,!0),h.setUint16(32,0,!0),h.setUint16(34,0,!0),h.setUint16(36,0,!0),h.setUint32(38,0,!0),h.setUint32(42,l,!0);const S=new Uint8Array(b);S.set(d,46),r.push(b),l+=g.length+s.length,i+=S.length}const t=new ArrayBuffer(22),a=new DataView(t);a.setUint32(0,101010256,!0),a.setUint16(4,0,!0),a.setUint16(6,0,!0),a.setUint16(8,e.length,!0),a.setUint16(10,e.length,!0),a.setUint32(12,i,!0),a.setUint32(16,l,!0),a.setUint16(20,0,!0);const p=[...n,...r,t];return new Blob(p,{type:"application/zip"})},Yr=e=>e.trim().toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"drum-session",Xr=mt.filter(e=>e<=16),ea=A({name:"DrumMachine",components:{TransportBar:Ot,PadGrid:Ft,StepGrid:Et,TabPanel:$t,SoundPanel:wr,FxPanel:Ur,PatternsPanel:Mr,ExportPanel:Jr},data(){const e=$e(),n=gt(),r=mn(),l=hn(),i=Wn();l.setCapabilities(i.capabilities.value);const t=Jn(),a=kn({getPattern:()=>n.currentPattern,onPatternBoundary:()=>n.advanceScenePlayback()}),p=xn(),s=wn("internal",{midi:p,getAudioTime:()=>a.getAudioTime(),onExternalStart:()=>{e.isPlaying||(n.prepareScenePlayback(),a.start().catch(y=>{console.error("Failed to start sequencer from external sync",y)}))},onExternalStop:()=>{e.isPlaying&&a.stop()}}),f=Un(),d=Mn(),u=["pad1","pad2","pad3","pad4","pad5","pad6","pad7","pad8","pad9","pad10","pad11","pad12","pad13","pad14","pad15","pad16"],v=[...Xr],g={id:"default-kit",name:"Default Kit",createdAt:Date.now(),updatedAt:Date.now(),pads:{pad1:{id:"kick",name:"Kick",url:"/samples/kick.wav",format:"wav"},pad5:{id:"kick-2",name:"Kick 2",url:"/samples/kick.wav",format:"wav"},pad9:{id:"kick-3",name:"Kick 3",url:"/samples/kick.wav",format:"wav"},pad13:{id:"kick-4",name:"Kick 4",url:"/samples/kick.wav",format:"wav"},pad2:{id:"snare",name:"Snare",url:"/samples/snare.wav",format:"wav"},pad6:{id:"snare-2",name:"Snare 2",url:"/samples/snare.wav",format:"wav"},pad10:{id:"snare-3",name:"Snare 3",url:"/samples/snare.wav",format:"wav"},pad14:{id:"snare-4",name:"Snare 4",url:"/samples/snare.wav",format:"wav"},pad3:{id:"hihat",name:"Hi-Hat",url:"/samples/hihat.wav",format:"wav"},pad7:{id:"hihat-2",name:"Hi-Hat 2",url:"/samples/hihat.wav",format:"wav"},pad11:{id:"hihat-3",name:"Hi-Hat 3",url:"/samples/hihat.wav",format:"wav"},pad15:{id:"hihat-4",name:"Hi-Hat 4",url:"/samples/hihat.wav",format:"wav"},pad4:{id:"clap",name:"Clap",url:"/samples/clap.wav",format:"wav"},pad8:{id:"clap-2",name:"Clap 2",url:"/samples/clap.wav",format:"wav"},pad12:{id:"clap-3",name:"Clap 3",url:"/samples/clap.wav",format:"wav"},pad16:{id:"clap-4",name:"Clap 4",url:"/samples/clap.wav",format:"wav"}}};return r.banks.length===0&&r.setBanks([g]),{transport:e,patterns:n,soundbanks:r,session:l,sequencer:a,sync:s,midi:p,patternStorage:f,soundbankStorage:d,pads:u,divisions:v,defaultBank:g,unwatchers:[],exportMetadata:null,exportAudioBlob:null,exportTimeline:void 0,exportStems:null,isExporting:!1,exportError:null,exportAudioFn:t.exportAudio,selectedPadId:"pad1",drawerTab:"sound"}},computed:{gridSpec(){return this.patterns.currentPattern?.gridSpec??{...D}},pattern(){return this.patterns.currentPattern??{id:"pattern-1",name:"Pattern 1",gridSpec:{...D},steps:{}}},currentStep(){return this.transport.currentStep},bpm(){return this.transport.bpm},isPlaying(){return this.transport.isPlaying},midiInputs(){return this.midi.inputs},midiOutputs(){return this.midi.outputs},banks(){return this.soundbanks.banks},syncState(){return this.sync.state},capabilities(){return this.session.capabilities},padStates(){const e=this.soundbanks.currentBank?.pads??{},n={},r=Math.max(1,this.gridSpec.bars*this.gridSpec.division),l=(this.currentStep%r+r)%r,i=Math.floor(l/this.gridSpec.division),t=l%this.gridSpec.division,a=this.pattern.steps[i]?.[t]??{},p=new Set(Object.keys(a)),c=new Set;return Object.values(this.pattern.steps).forEach(o=>{Object.values(o).forEach(s=>{Object.keys(s).forEach(f=>c.add(f))})}),this.pads.forEach(o=>{n[o]={label:e[o]?.name??o.toUpperCase(),isTriggered:p.has(o),isPlaying:this.isPlaying&&c.has(o)}}),n},hasZipArtifacts(){return!!(this.exportMetadata&&this.exportAudioBlob)},stemEntries(){if(!this.exportStems)return[];const e=this.soundbanks.currentBank?.pads??{};return Object.entries(this.exportStems).map(([n,r])=>({padId:n,label:e[n]?.name??n,fileName:r.fileName}))}},mounted(){const e=this.patternStorage.load();e.patterns.length>0&&this.patterns.setPatterns(e.patterns),e.scenes.length>0&&this.patterns.setScenes(e.scenes),e.selectedPatternId&&this.patterns.patterns.find(t=>t.id===e.selectedPatternId)&&this.patterns.selectPattern(e.selectedPatternId),this.patterns.selectScene(e.activeSceneId??null),this.initializeSoundbank();const n=()=>this.patternStorage.save({patterns:this.patterns.patterns,scenes:this.patterns.scenes,selectedPatternId:this.patterns.selectedPatternId,activeSceneId:this.patterns.activeSceneId}),r=this.$watch(()=>[this.patterns.patterns,this.patterns.scenes,this.patterns.selectedPatternId,this.patterns.activeSceneId],n,{deep:!0}),l=this.$watch(()=>this.patterns.patterns,t=>{const a=this.soundbanks.selectedBankId;a&&this.soundbankStorage.savePatterns(a,t)},{deep:!0}),i=this.midi.listen(t=>{if(t.type==="noteon"&&typeof t.note=="number"){const a=this.midi.mapNoteToPad(t.note);a&&this.handlePad(a,t.velocity??1)}});this.unwatchers.push(r),this.unwatchers.push(l),this.unwatchers.push(()=>i?.())},beforeUnmount(){this.unwatchers.forEach(e=>e())},methods:{addPattern(e){this.patterns.addPattern(e?.name)},selectPattern(e){this.patterns.selectPattern(e)},renamePattern(e){this.patterns.renamePattern(e.id,e.name)},undoPattern(){this.patterns.undo()},redoPattern(){this.patterns.redo()},addScene(e){this.patterns.addScene(e?.name??"Scene",e?.patternIds??[])},updateScene(e){const n={};typeof e.name=="string"&&(n.name=e.name),Array.isArray(e.patternIds)&&(n.patternIds=e.patternIds),Object.keys(n).length>0&&this.patterns.updateScene(e.id,n)},selectScene(e){this.patterns.selectScene(e)},updateFx(e){this.sequencer.setFx(e)},updateBpm(e){this.transport.setBpm(e),this.sync.setBpm(e)},async start(){this.transport.isPlaying||(this.patterns.prepareScenePlayback(),await this.sequencer.start(),this.sync.startTransport(this.transport.bpm))},stop(){this.sequencer.stop(),this.sync.stopTransport()},async handlePad(e,n=1){try{await this.sequencer.recordHit(e,n,!0)}catch(r){console.error("Failed to trigger pad",r)}this.selectPad(e)},selectPad(e){this.selectedPadId=e},toggleStep(e){this.patterns.toggleStep(e.barIndex,e.stepInBar,e.padId)},async requestMidi(){await this.midi.requestAccess(),this.session.setCapabilities({supportsAudioInput:this.session.capabilities.supportsAudioInput,supportsWebMIDI:this.midi.supportsMidi()}),this.midi.inputs.length>0&&!this.midi.selectedInputId&&this.midi.setSelectedInput(this.midi.inputs[0]?.id??null),this.midi.outputs.length>0&&!this.midi.selectedOutputId&&this.midi.setSelectedOutput(this.midi.outputs[0]?.id??null)},selectMidiInput(e){this.midi.setSelectedInput(e)},selectMidiOutput(e){this.midi.setSelectedOutput(e)},mapPadToNote(e){e.note>=0&&e.note<=127&&this.midi.setPadForNote(e.note,e.padId)},setSyncMode(e){(e==="internal"||e==="midiClock"||e==="abletonLink")&&this.sync.setMode(e)},setSyncRole(e){(e==="master"||e==="slave")&&this.sync.setRole(e)},setLoop(e){this.transport.setLoop(e)},setDivision(e){const n=L({...this.gridSpec,division:e});this.transport.setGridSpec(n),this.patterns.updateGridSpec(n)},selectBank(e){this.soundbanks.selectBank(e),this.initializeSoundbank()},inferFormatFromName(e){const n=e.toLowerCase();if(n.endsWith(".wav"))return"wav";if(n.endsWith(".mp3"))return"mp3";if(n.endsWith(".ogg"))return"ogg";if(n.endsWith(".aac"))return"aac";if(n.endsWith(".flac"))return"flac"},async replacePadSample(e){const n=this.soundbanks.currentBank??this.defaultBank,r=n.pads[e.padId];r?.url&&r.url.startsWith("blob:")&&URL.revokeObjectURL(r.url);const l=`${e.padId}-${Date.now()}`,i=this.inferFormatFromName(e.file.name)??"wav",t={id:l,name:e.file.name,format:i,blob:e.file,url:URL.createObjectURL(e.file)},a={...n,pads:{...n.pads,[e.padId]:t},updatedAt:Date.now()};this.soundbanks.upsertBank(a),await this.soundbankStorage.saveBank(a),await this.soundbankStorage.saveSample(t),await this.sequencer.setSampleForPad(e.padId,t),await this.sequencer.applySoundbank(a)},async hydrateSamplesForBank(e){const n={},r=Object.entries(e.pads);for(const[l,i]of r){if(!i)continue;let t=i;if(!i.blob){const a=await this.soundbankStorage.loadSample(i.id);a?.blob&&(t={...i,blob:a.blob})}n[l]=t}return{...e,pads:n}},async initializeSoundbank(){const e=await this.soundbankStorage.loadBanks();e.length>0?this.soundbanks.setBanks(e):this.soundbanks.banks.length===0&&(this.soundbanks.setBanks([this.defaultBank]),await this.soundbankStorage.saveBank(this.defaultBank));const n=this.soundbanks.currentBank??this.soundbanks.banks[0]??this.defaultBank,r=await this.hydrateSamplesForBank(n);this.soundbanks.upsertBank(r);const l=await this.soundbankStorage.loadPatterns(r.id);l.length>0&&this.patterns.setPatterns(l),await this.sequencer.applySoundbank(r)},getScenePatternChain(){const n=(this.patterns.currentScene?.patternIds??[]).filter(l=>this.patterns.patterns.some(i=>i.id===l));if(n.length>0)return n;const r=this.patterns.selectedPatternId??this.patterns.patterns[0]?.id;return r?[r]:[]},computeExportDuration(){const e=Math.max(1,this.transport.bpm);return(this.getScenePatternChain().reduce((i,t)=>{const a=this.patterns.patterns.find(p=>p.id===t);return i+(a?.gridSpec?.bars??D.bars)},0)||D.bars)*4*60/e},async exportBounce(){if(!this.isExporting){this.isExporting=!0,this.exportError=null,this.exportStems=null;try{const e=await this.exportAudioFn(this.computeExportDuration());this.exportMetadata=e.metadata,this.exportAudioBlob=e.audioBlob,this.exportTimeline=e.debugTimeline,this.exportStems=e.stems??null}catch(e){console.error("Failed to export audio",e),this.exportError="Failed to export audio",this.exportStems=null}finally{this.isExporting=!1}}},downloadStem(e){if(this.isExporting)return;const n=this.exportStems?.[e];n&&R.saveAs(n.blob,n.fileName)},downloadMixdown(){this.isExporting||this.exportAudioBlob&&R.saveAs(this.exportAudioBlob,"mixdown.wav")},downloadAllStems(){this.isExporting||!this.exportStems||Object.values(this.exportStems).forEach(e=>{R.saveAs(e.blob,e.fileName)})},async downloadZip(){if(!(this.isExporting||!this.hasZipArtifacts))try{const e=this.exportMetadata,n=this.exportAudioBlob;if(!e||!n)return;const r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),l=[{name:"mixdown.wav",blob:n},{name:"render-meta.json",blob:r}];this.exportStems&&Object.entries(this.exportStems).forEach(([c,o])=>{l.push({name:`stems/${c}.wav`,blob:o.blob})});const i=await Promise.all(l.map(async c=>({name:c.name,data:new Uint8Array(await c.blob.arrayBuffer())}))),t=Qr(i),a=Yr(this.soundbanks.currentBank?.name??this.patterns.currentScene?.name??this.pattern?.name??"drum-session"),p=e.seed??Date.now().toString();R.saveAs(t,`${a}_${p}.zip`)}catch(e){console.error("Failed to create ZIP archive",e)}}}}),ta={class:"drumshell"},na={class:"hardware-top"},ra={class:"main-shell"},aa={class:"pads-panel"},sa={class:"sequencer-panel"},ia={class:"drawer-wrapper"},oa={class:"drawer-scroll"};function la(e,n,r,l,i,t){const a=Ot,p=Ft,c=Et,o=B("SoundPanel"),s=B("FxPanel"),f=B("PatternsPanel"),d=B("ExportPanel"),u=$t,v=sn;return C(),F("div",ta,[U("div",na,[I(a,{bpm:e.bpm,isPlaying:e.isPlaying,loop:e.transport.loop,division:e.gridSpec.division,divisions:e.divisions,onPlay:e.start,onStop:e.stop,"onBpm:update":e.updateBpm,"onLoop:update":e.setLoop,"onDivision:update":e.setDivision},null,8,["bpm","isPlaying","loop","division","divisions","onPlay","onStop","onBpm:update","onLoop:update","onDivision:update"])]),U("div",ra,[U("div",aa,[I(p,{pads:e.pads,"selected-pad":e.selectedPadId,"pad-states":e.padStates,"onPad:down":e.handlePad,"onPad:select":e.selectPad},null,8,["pads","selected-pad","pad-states","onPad:down","onPad:select"])]),U("div",sa,[I(c,{"grid-spec":e.gridSpec,steps:e.pattern.steps,"selected-pad":e.selectedPadId,"current-step":e.currentStep,"is-playing":e.isPlaying,"onStep:toggle":e.toggleStep},null,8,["grid-spec","steps","selected-pad","current-step","is-playing","onStep:toggle"])])]),U("div",ia,[I(v,{tag:"div"},{default:P(()=>[U("div",oa,[I(u,{modelValue:e.drawerTab,"onUpdate:modelValue":n[0]||(n[0]=g=>e.drawerTab=g)},{sound:P(()=>[I(o,{banks:e.banks,"selected-bank-id":e.soundbanks.selectedBankId,"onBank:select":e.selectBank,"onPad:replace":e.replacePadSample},null,8,["banks","selected-bank-id","onBank:select","onPad:replace"])]),fx:P(()=>[I(s,{fxSettings:e.sequencer.fxSettings,"onFx:update":e.updateFx},null,8,["fxSettings","onFx:update"])]),patterns:P(()=>[I(f,{patterns:e.patterns.patterns,"selected-pattern-id":e.patterns.selectedPatternId,scenes:e.patterns.scenes,"active-scene-id":e.patterns.activeSceneId,"onPattern:add":e.addPattern,"onPattern:select":e.selectPattern,"onPattern:rename":e.renamePattern,"onPattern:undo":e.undoPattern,"onPattern:redo":e.redoPattern,"onScene:add":e.addScene,"onScene:update":e.updateScene,"onScene:select":e.selectScene},null,8,["patterns","selected-pattern-id","scenes","active-scene-id","onPattern:add","onPattern:select","onPattern:rename","onPattern:undo","onPattern:redo","onScene:add","onScene:update","onScene:select"])]),export:P(()=>[I(d,{isExporting:e.isExporting,exportError:e.exportError,exportMetadata:e.exportMetadata,audioBlob:e.exportAudioBlob,hasZipArtifacts:e.hasZipArtifacts,stemEntries:e.stemEntries,onExport:e.exportBounce,"onDownload:mixdown":e.downloadMixdown,"onDownload:zip":e.downloadZip,"onDownload:stem":e.downloadStem,"onDownload:stems":e.downloadAllStems},null,8,["isExporting","exportError","exportMetadata","audioBlob","hasZipArtifacts","stemEntries","onExport","onDownload:mixdown","onDownload:zip","onDownload:stem","onDownload:stems"])]),_:1},8,["modelValue"])])]),_:1})])])}const Vt=Object.assign($(ea,[["render",la],["__scopeId","data-v-58e91f09"]]),{__name:"DrumMachine"}),ca=A({name:"IndexPage",components:{DrumMachine:Vt}});function da(e,n,r,l,i,t){const a=Vt;return C(),E(a)}const ha=$(ca,[["render",da]]);export{ha as default};
